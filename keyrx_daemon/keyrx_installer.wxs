<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <Product
    Id="*"
    Name="KeyRx Keyboard Remapper"
    Language="1033"
    Version="0.1.0.0"
    Manufacturer="KeyRx Project"
    UpgradeCode="A5B3C8D1-E9F2-4A7C-B6D3-1E8F9A2C5D7B">

    <Package
      InstallerVersion="200"
      Compressed="yes"
      InstallScope="perMachine"
      Platform="x64"
      Description="KeyRx - Advanced Keyboard Remapping Software"
      Comments="Powerful keyboard remapping with multi-device support and web UI" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
    <MediaTemplate EmbedCab="yes" />

    <Feature Id="ProductFeature" Title="KeyRx Core" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentGroupRef Id="ProductBinaries" />
      <ComponentRef Id="StartMenuShortcut" />
    </Feature>

    <!-- Custom icon for Add/Remove Programs -->
    <Icon Id="ProductIcon" SourceFile="keyrx_daemon\assets\icon.ico" />
    <Property Id="ARPPRODUCTICON" Value="ProductIcon" />

    <!-- Add to PATH -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <UI>
      <UIRef Id="WixUI_InstallDir" />
      <Publish Dialog="ExitDialog"
          Control="Finish"
          Event="DoAction"
          Value="LaunchApplication">
        WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed
      </Publish>
    </UI>

    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch KeyRx Daemon" />
    <Property Id="WixShellExecTarget" Value="[#keyrx_daemon.exe]" />
    <CustomAction Id="LaunchApplication"
        BinaryKey="WixCA"
        DllEntry="WixShellExec"
        Impersonate="yes" />
  </Product>

  <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="INSTALLFOLDER" Name="KeyRx">
          <Directory Id="BinFolder" Name="bin" />
          <Directory Id="ConfigFolder" Name="config" />
        </Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="KeyRx" />
      </Directory>
    </Directory>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="ProductBinaries" Directory="BinFolder">
      <Component Id="keyrx_daemon" Guid="B1C2D3E4-F5A6-7B8C-9D0E-1F2A3B4C5D6E" Win64="yes">
        <File
          Id="keyrx_daemon.exe"
          Source="target\release\keyrx_daemon.exe"
          KeyPath="yes" />

        <!-- Add to PATH -->
        <Environment
          Id="PATH"
          Name="PATH"
          Value="[BinFolder]"
          Permanent="no"
          Part="last"
          Action="set"
          System="yes" />
      </Component>

      <Component Id="keyrx_compiler" Guid="C2D3E4F5-A6B7-8C9D-0E1F-2A3B4C5D6E7F" Win64="yes">
        <File
          Id="keyrx_compiler.exe"
          Source="target\release\keyrx_compiler.exe"
          KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="LicenseComponent" Guid="D3E4F5A6-B7C8-9D0E-1F2A-3B4C5D6E7F8A" Win64="yes">
        <File Id="LICENSE" Source="LICENSE" KeyPath="yes" />
      </Component>

      <Component Id="ReadmeComponent" Guid="E4F5A6B7-C8D9-0E1F-2A3B-4C5D6E7F8A9B" Win64="yes">
        <File Id="README.md" Source="README.md" KeyPath="yes" />
      </Component>

      <Component Id="ExampleConfigComponent" Guid="F5A6B7C8-D9E0-1F2A-3B4C-5D6E7F8A9B0C" Win64="yes">
        <File
          Id="user_layout.krx"
          Source="user_layout.krx"
          KeyPath="yes" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="StartMenuShortcut" Guid="A6B7C8D9-E0F1-2A3B-4C5D-6E7F8A9B0C1D">
        <Shortcut
          Id="StartMenuDaemon"
          Name="KeyRx Daemon"
          Target="[BinFolder]keyrx_daemon.exe"
          WorkingDirectory="BinFolder"
          Icon="ProductIcon"
          IconIndex="0" />
        <RemoveFolder Id="CleanUpStartMenu" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\KeyRx" Name="installed" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>
  </Fragment>
</Wix>
