# Macro Recorder

The Macro Recorder allows you to capture keyboard input sequences and convert them into reusable Rhai macros for KeyRX.

## Overview

The macro recorder captures real-time keyboard events (key presses and releases) with precise timestamps, allowing you to:

- Record keyboard sequences as you type
- Edit captured events (timing, key codes)
- Generate Rhai macro code
- Test macros with the WASM simulator
- Export macros as JSON or Rhai code

## Getting Started

### Prerequisites

- KeyRX daemon running (`keyrx_daemon`)
- KeyRX UI accessible (default: `http://localhost:5173`)

### Accessing the Macro Recorder

1. Open the KeyRX UI in your browser
2. Click the **Macro Recorder** button in the navigation bar
3. The macro recorder interface will appear

## Recording a Macro

### Basic Recording

1. Click **Start Recording** button
2. Type your desired key sequence
3. Click **Stop Recording** button
4. Your events will appear in the events table

### Recording Indicators

When recording is active:
- Recording indicator displayed (e.g., red dot or "Recording..." text)
- Stop Recording button is visible
- All keyboard input is captured with microsecond timestamps

### What Gets Recorded

Each keyboard event includes:
- **Type**: Press or Release
- **Key Code**: Numeric Linux input event code
- **Timestamp**: Microseconds since recording started
- **Virtual Key Name**: Human-readable key name (e.g., VK_A, VK_ENTER)

## Working with Recorded Events

### Viewing Events

The events table displays:
- Event number (sequence)
- Event type (Press/Release)
- Key code and name
- Timestamp (μs)
- Actions (Edit/Delete)

### Editing Events

To edit an event:
1. Click **Edit** button on the event row
2. Modify the key code or timestamp
3. Click **Save** to apply changes
4. Click **Cancel** to discard changes

**Note**: Edited events are used for code generation and testing.

### Deleting Events

To remove an event:
1. Click **Delete** button on the event row
2. The event is removed from the sequence
3. Subsequent events maintain their original timestamps

### Clearing All Events

Click the **Clear** button to remove all recorded events and start fresh.

## Generating Rhai Code

### Automatic Generation

Rhai macro code is automatically generated from your recorded events. The generated code includes:
- Macro name
- Key press and release actions
- Timing delays between events

### Example Generated Code

```rhai
macro "recorded_macro_001" {
    press(VK_H);
    delay_ms(50);
    release(VK_H);
    delay_ms(100);
    press(VK_E);
    delay_ms(45);
    release(VK_E);
    // ... more events
}
```

### Copying Rhai Code

1. Locate the "Generated Rhai Code" section
2. Click the **Copy** button
3. Paste into your KeyRX configuration file

## Testing Macros

### Using the Simulator

To test your macro before deploying:

1. Ensure you have a valid Rhai configuration loaded in the simulator
2. Click **Test Macro** button in the test panel
3. The WASM simulator runs your macro
4. Results display showing output events

### Interpreting Test Results

Test results show:
- Output events generated by the macro
- Timing information
- Any errors or warnings

## Text Snippet Templates

### Converting Text to Macros

To create a macro from text:

1. Locate the "Text Snippet" section
2. Enter your text in the input field
3. Click **Convert** or **Generate**
4. Events are generated for each character

### How It Works

The text snippet converter:
- Converts each character to key press/release pairs
- Handles shift modifiers for uppercase and symbols
- Adds realistic timing between keystrokes
- Generates proper key codes for special characters

### Example

Input: `Hello`

Generates:
- Shift Press → H Press → H Release → Shift Release (uppercase H)
- E Press → E Release
- L Press → L Release
- L Press → L Release
- O Press → O Release

## Template Library

### Using Pre-built Templates

The template library provides common macro patterns:

1. Navigate to the "Template Library" section
2. Browse available templates:
   - Email signatures
   - Code snippets
   - Common text patterns
   - Keyboard shortcuts
3. Click a template to load it
4. Edit as needed

### Available Templates

Templates include:
- **Email Signature**: Professional email closing
- **Code Block**: Common code patterns
- **Lorem Ipsum**: Placeholder text
- **Special Characters**: Symbol sequences
- **Emoji**: Emoji shortcuts

## Exporting Macros

### Export as JSON

To save events in JSON format:

1. Record or edit your macro
2. Click **Export JSON** button
3. File downloads as `macro_TIMESTAMP.json`

JSON format includes:
```json
[
  {
    "type": "Press",
    "key_code": 30,
    "timestamp_us": 0
  },
  {
    "type": "Release",
    "key_code": 30,
    "timestamp_us": 50000
  }
]
```

### Export as Rhai

To export as Rhai code:

1. Copy the generated Rhai code
2. Paste into your `.rhai` configuration file
3. Integrate with your KeyRX setup

## Integration with KeyRX

### Adding Macros to Configuration

1. Copy the generated Rhai code
2. Open your KeyRX configuration file
3. Add the macro definition
4. Bind the macro to a key or key combination

Example:
```rhai
// Define the macro
macro "my_signature" {
    press(VK_B);
    release(VK_B);
    // ... rest of macro
}

// Bind to a key
layer "base" {
    map KEY_F1 to run_macro("my_signature")
}
```

### Compiling Configuration

After adding macros:

1. Save your `.rhai` file
2. Compile with `keyrx_compiler`:
   ```bash
   keyrx_compiler config.rhai -o config.krx
   ```
3. Load the compiled configuration in the daemon

## Advanced Features

### Editing Timestamps

Fine-tune timing by editing event timestamps:
- Timestamps are in microseconds
- Smaller values = faster playback
- Larger values = slower playback

### Combining Macros

Combine multiple recorded sequences:
1. Record first sequence
2. Export as JSON
3. Record second sequence
4. Manually merge JSON files
5. Re-import combined sequence

### Custom Key Codes

Use custom key codes for special keys:
- Find Linux input event codes in `/usr/include/linux/input-event-codes.h`
- Edit events to use specific codes
- Common codes:
  - `KEY_A` = 30
  - `KEY_ENTER` = 28
  - `KEY_ESC` = 1
  - `KEY_LEFTSHIFT` = 42

## Troubleshooting

### Recording Not Starting

**Problem**: Click Start Recording but nothing happens

**Solutions**:
- Verify KeyRX daemon is running
- Check daemon is accessible on expected port
- Look for error messages in the UI
- Check browser console for errors

### Events Not Captured

**Problem**: Recording active but no events appear

**Solutions**:
- Ensure keyboard focus is on a valid input area
- Check daemon logs for errors
- Verify device permissions (Linux: read access to `/dev/input/*`)
- Try restarting the daemon

### Generated Code Invalid

**Problem**: Rhai code doesn't compile

**Solutions**:
- Check for invalid key names
- Verify macro syntax matches KeyRX spec
- Look for timing issues (negative delays)
- Test in simulator before deploying

### Export Not Working

**Problem**: Export button disabled or download fails

**Solutions**:
- Ensure you have recorded events
- Check browser download permissions
- Verify disk space available
- Try different browser

### Simulator Test Fails

**Problem**: Test macro produces unexpected results

**Solutions**:
- Verify configuration is loaded in simulator
- Check event sequence is correct
- Review generated Rhai code for errors
- Test with simpler macro first

## Best Practices

### Recording Tips

1. **Plan ahead**: Know what you want to record before starting
2. **Record slowly**: Easier to speed up than slow down
3. **Use clear keystrokes**: Avoid key chording unless intentional
4. **Test early**: Test macros frequently during development

### Editing Tips

1. **Preserve timing**: Maintain relative timing between events
2. **Clean up mistakes**: Delete accidental keypresses
3. **Normalize delays**: Round timestamps for consistency
4. **Document intent**: Add comments to generated Rhai code

### Performance Tips

1. **Minimize delays**: Remove unnecessary wait times
2. **Batch similar events**: Group related keystrokes
3. **Avoid long macros**: Break complex sequences into smaller macros
4. **Test impact**: Measure macro execution time with simulator

## API Reference

### REST API Endpoints

The macro recorder uses these daemon endpoints:

#### Start Recording
```
POST /api/macros/start-recording
```

Response:
```json
{
  "status": "recording"
}
```

#### Stop Recording
```
POST /api/macros/stop-recording
```

Response:
```json
{
  "status": "stopped",
  "event_count": 42
}
```

#### Get Recorded Events
```
GET /api/macros/recorded-events
```

Response:
```json
{
  "events": [
    {
      "type": "Press",
      "key_code": 30,
      "timestamp_us": 0
    }
  ]
}
```

### WebSocket Updates

Real-time event updates via WebSocket:

```javascript
ws://localhost:PORT/ws

Message format:
{
  "type": "macro_event",
  "event": {
    "type": "Press",
    "key_code": 30,
    "timestamp_us": 12345
  }
}
```

## Keyboard Shortcuts

### Global Shortcuts

- `Tab`: Navigate between controls
- `Enter` / `Space`: Activate focused button
- `Esc`: Cancel editing

### Recording Shortcuts

- `Ctrl+R`: Start recording (if supported)
- `Ctrl+S`: Stop recording (if supported)
- `Ctrl+C`: Clear events (if supported)

## Accessibility

### Screen Reader Support

- All buttons have ARIA labels
- Event table includes proper headers
- Recording state announced
- Error messages accessible

### Keyboard Navigation

- Full keyboard navigation support
- Focus indicators visible
- Logical tab order
- No mouse-only features

## Examples

### Example 1: Email Signature

```rhai
macro "email_signature" {
    // "Best regards,"
    press(VK_B); release(VK_B); delay_ms(50);
    press(VK_E); release(VK_E); delay_ms(50);
    press(VK_S); release(VK_S); delay_ms(50);
    press(VK_T); release(VK_T); delay_ms(50);
    press(VK_SPACE); release(VK_SPACE); delay_ms(50);
    press(VK_R); release(VK_R); delay_ms(50);
    // ... rest of signature
}
```

### Example 2: Code Snippet

```rhai
macro "for_loop" {
    // "for (int i = 0; i < 10; i++)"
    press(VK_F); release(VK_F); delay_ms(40);
    press(VK_O); release(VK_O); delay_ms(40);
    press(VK_R); release(VK_R); delay_ms(40);
    press(VK_SPACE); release(VK_SPACE); delay_ms(40);
    // ... rest of loop
}
```

### Example 3: Window Management

```rhai
macro "tile_windows" {
    // Win+Left
    press(VK_LWIN); delay_ms(10);
    press(VK_LEFT); delay_ms(50);
    release(VK_LEFT); delay_ms(10);
    release(VK_LWIN); delay_ms(200);

    // Alt+Tab
    press(VK_LALT); delay_ms(10);
    press(VK_TAB); delay_ms(50);
    release(VK_TAB); delay_ms(10);
    release(VK_LALT);
}
```

## Further Reading

- [KeyRX Configuration Guide](./configuration.md)
- [Rhai Language Reference](./rhai-reference.md)
- [WASM Simulator Guide](./simulator.md)
- [API Documentation](./api.md)

## Support

For issues or questions:
- GitHub Issues: [keyrx2/issues](https://github.com/yourusername/keyrx2/issues)
- Documentation: [docs/](../docs/)
- Examples: [examples/](../examples/)
