{
  "id": "snapshot_1767365576308_9yza3vmlh",
  "approvalId": "approval_1767365576292_1k5xh1jsf",
  "approvalTitle": "Design Document - Production Readiness Remediation",
  "version": 1,
  "timestamp": "2026-01-02T14:52:56.308Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\n\n## Overview\n\nThis design addresses production readiness blockers discovered during pre-production verification of the keyrx-ui-ux-refinement implementation. The primary focus is fixing test failures, implementing coverage verification, conducting accessibility audits, and resolving backend doc test compilation issues.\n\n**Core Strategy:**\n1. Fix test infrastructure to wrap context-dependent components (MonacoEditor)\n2. Install and configure coverage tooling (@vitest/coverage-v8)\n3. Integrate accessibility testing (axe-core, Lighthouse CI)\n4. Resolve backend crate version conflicts\n\nThis remediation follows a **quality gate enforcement** pattern: automated verification prevents production deployment until all standards are met.\n\n## Steering Document Alignment\n\n### Technical Standards (tech.md)\n\n**Code Quality Enforcement (KPI):**\n- Enforces 80% minimum test coverage requirement\n- Validates WCAG 2.2 Level AA compliance (accessibility standard)\n- Pre-commit hook integration for automated verification\n\n**Architecture Patterns:**\n- **Dependency Injection**: Test helpers inject WasmProvider context\n- **SOLID Principles**: Each test utility has single responsibility (e.g., renderWithProviders only handles provider setup)\n- **Structured Logging**: Test results in JSON format for CI/CD parsing\n\n**Error Handling:**\n- Fail fast: Tests fail immediately on assertion errors\n- Structured test output: JSON reports for coverage and accessibility\n- Clear error messages: Test failures include actionable fix guidance\n\n### Project Structure (structure.md)\n\n**Frontend Test Location:**\n- Unit tests: `keyrx_ui/tests/` (shared utilities)\n- Component tests: `keyrx_ui/src/components/*.test.tsx`\n- Integration tests: `keyrx_ui/tests/integration/`\n\n**Backend Test Location:**\n- Library tests: `keyrx_daemon/src/**/*_test.rs`\n- Doc tests: Inline in source files with `/// # Examples`\n- Integration tests: `keyrx_daemon/tests/`\n\n**Coverage Reports:**\n- Frontend: `keyrx_ui/coverage/` (HTML + JSON)\n- Backend: `target/tarpaulin/` (HTML + JSON)\n\n## Code Reuse Analysis\n\n### Existing Components to Leverage\n\n**Frontend Testing Infrastructure:**\n- **Vitest**: Already configured in `keyrx_ui/vite.config.ts`\n- **React Testing Library**: Used in existing tests (`useAutoSave.test.tsx`)\n- **WasmContext**: Existing context provider in `keyrx_ui/src/contexts/WasmContext.tsx`\n\n**Backend Testing Infrastructure:**\n- **Cargo test**: Workspace-level test execution\n- **Tarpaulin**: Code coverage tool (already in Makefile)\n- **Doc tests**: Existing pattern in keyrx_core modules\n\n**Accessibility Tools (New):**\n- **axe-core**: Industry-standard WCAG validator\n- **Lighthouse CI**: Automated performance and accessibility audits\n- **jest-axe**: Vitest-compatible accessibility assertions\n\n### Integration Points\n\n**Test Utilities Integration:**\n- Extend existing `keyrx_ui/tests/testUtils.tsx` with WasmProviderWrapper\n- Add `renderWithProviders` helper for context injection\n\n**CI/CD Integration:**\n- Extend `.github/workflows/ci.yml` with coverage gates\n- Add accessibility audit step to CI pipeline\n- Fail builds on coverage <80% or accessibility violations\n\n**Coverage Reporting:**\n- Frontend: Vitest coverage-v8 plugin outputs to coverage/\n- Backend: Tarpaulin outputs to target/tarpaulin/\n- Both generate JSON for dashboard consumption\n\n## Architecture\n\n### Test Infrastructure Architecture\n\n```mermaid\ngraph TD\n    subgraph Frontend Testing\n        A[Component Tests] --> B[renderWithProviders Helper]\n        B --> C[WasmProvider Context]\n        B --> D[React Query Provider]\n        A --> E[Vitest Test Runner]\n        E --> F[Coverage-v8 Plugin]\n        F --> G[Coverage Report JSON]\n    end\n\n    subgraph Backend Testing\n        H[Lib Tests] --> I[cargo test --lib]\n        J[Doc Tests] --> K[cargo test --doc]\n        I --> L[Tarpaulin Coverage]\n        K --> L\n        L --> M[Coverage Report JSON]\n    end\n\n    subgraph Accessibility Testing\n        N[Page Components] --> O[axe-core Scanner]\n        N --> P[Lighthouse CI]\n        O --> Q[WCAG Violations Report]\n        P --> Q\n    end\n\n    subgraph Quality Gates\n        G --> R[Dashboard Parser]\n        M --> R\n        Q --> R\n        R --> S{All Gates Pass?}\n        S -->|Yes| T[Approve Production]\n        S -->|No| U[Block Deployment]\n    end\n```\n\n### Modular Design Principles\n\n**Test Helper Modularity:**\n- **Single File Responsibility**: `WasmProviderWrapper.tsx` only handles WASM context injection\n- **Component Isolation**: Each test file tests one component in isolation\n- **Service Layer Separation**: Test data factories separate from test logic\n- **Utility Modularity**: Coverage reporters separate from test runners\n\n**File Organization:**\n```\nkeyrx_ui/\n├── tests/\n│   ├── testUtils.tsx           # Shared test helpers (renderWithProviders)\n│   ├── WasmProviderWrapper.tsx # WASM context injection utility\n│   ├── AccessibilityTestHelper.tsx # Accessibility test utilities\n│   └── integration/            # Integration test suites\n├── coverage/                   # Generated coverage reports (gitignored)\n└── lighthouse/                 # Lighthouse CI reports (gitignored)\n```\n\n## Components and Interfaces\n\n### Component 1: WasmProviderWrapper (Frontend)\n\n- **Purpose:** Inject WasmProvider context into test components\n- **Interfaces:**\n  ```typescript\n  export function WasmProviderWrapper({ children }: { children: ReactNode }): JSX.Element\n  ```\n- **Dependencies:**\n  - `keyrx_ui/src/contexts/WasmContext.tsx` (existing)\n  - React 18+\n- **Reuses:** Existing WasmProvider from production code\n\n### Component 2: renderWithProviders Helper (Frontend)\n\n- **Purpose:** Wrap components with all necessary providers for testing\n- **Interfaces:**\n  ```typescript\n  export function renderWithProviders(\n    ui: ReactElement,\n    options?: {\n      wrapWithWasm?: boolean;\n      wrapWithReactQuery?: boolean;\n      initialState?: Partial<AppState>;\n    }\n  ): RenderResult\n  ```\n- **Dependencies:**\n  - `@testing-library/react`\n  - `WasmProviderWrapper`\n  - `React Query QueryClientProvider`\n- **Reuses:** Extends existing testUtils.tsx pattern\n\n### Component 3: Coverage Reporter (Frontend)\n\n- **Purpose:** Generate coverage reports with 80% enforcement\n- **Interfaces:**\n  ```typescript\n  // vite.config.ts configuration\n  test: {\n    coverage: {\n      provider: 'v8',\n      reporter: ['text', 'json', 'html'],\n      all: true,\n      lines: 80,\n      branches: 80,\n      functions: 80,\n      statements: 80,\n      thresholds: {\n        autoUpdate: false,\n        lines: 80,\n        branches: 80,\n      }\n    }\n  }\n  ```\n- **Dependencies:**\n  - `@vitest/coverage-v8` (new dependency)\n  - Vitest ^1.0.0\n- **Reuses:** Existing Vitest configuration\n\n### Component 4: Accessibility Test Helper (Frontend)\n\n- **Purpose:** Run automated WCAG 2.2 Level AA audits\n- **Interfaces:**\n  ```typescript\n  export async function runAccessibilityAudit(\n    component: ReactElement\n  ): Promise<AxeResults>\n\n  export function expectNoA11yViolations(results: AxeResults): void\n  ```\n- **Dependencies:**\n  - `axe-core` (new)\n  - `jest-axe` (new)\n  - `@axe-core/react` (new)\n- **Reuses:** None (new infrastructure)\n\n### Component 5: Doc Test Fixer (Backend)\n\n- **Purpose:** Resolve crate version conflicts before doc tests\n- **Interfaces:**\n  ```bash\n  # Script interface\n  ./scripts/fix_doc_tests.sh\n  ```\n- **Dependencies:**\n  - `cargo clean`\n  - `cargo build --workspace`\n- **Reuses:** Existing Makefile build patterns\n\n## Data Models\n\n### Test Result Model (Frontend)\n\n```typescript\ninterface TestResult {\n  name: string;              // Test name\n  status: 'passed' | 'failed' | 'skipped';\n  duration: number;          // Milliseconds\n  error?: {\n    message: string;\n    stack: string;\n  };\n}\n\ninterface TestSuite {\n  name: string;              // File path\n  tests: TestResult[];\n  passRate: number;          // Percentage (0-100)\n}\n```\n\n### Coverage Report Model (Frontend + Backend)\n\n```typescript\ninterface CoverageReport {\n  lines: {\n    total: number;\n    covered: number;\n    percentage: number;       // 0-100\n  };\n  branches: {\n    total: number;\n    covered: number;\n    percentage: number;\n  };\n  functions: {\n    total: number;\n    covered: number;\n    percentage: number;\n  };\n  uncoveredLines: Array<{\n    file: string;\n    line: number;\n  }>;\n}\n```\n\n### Accessibility Violation Model (Frontend)\n\n```typescript\ninterface A11yViolation {\n  id: string;                // WCAG criterion ID (e.g., \"color-contrast\")\n  impact: 'critical' | 'serious' | 'moderate' | 'minor';\n  description: string;       // Human-readable description\n  helpUrl: string;           // Link to WCAG documentation\n  nodes: Array<{\n    html: string;            // Offending HTML element\n    target: string[];        // CSS selector path\n    failureSummary: string;  // What failed\n  }>;\n}\n\ninterface A11yReport {\n  violations: A11yViolation[];\n  passes: number;\n  incomplete: number;\n  timestamp: string;\n  url: string;\n}\n```\n\n## Error Handling\n\n### Error Scenarios\n\n#### 1. Test Failure Due to Missing Context\n- **Description:** Component test fails with \"useWasmContext must be used within WasmProvider\"\n- **Handling:**\n  1. Update test to use `renderWithProviders(component, { wrapWithWasm: true })`\n  2. Ensure WasmProviderWrapper is imported\n- **User Impact:** Developer sees clear error message with fix guidance in test output\n\n#### 2. Coverage Below Threshold\n- **Description:** Test coverage < 80% line/branch coverage\n- **Handling:**\n  1. Coverage tool fails with exit code 1\n  2. Report shows uncovered lines with file paths\n  3. CI pipeline blocks merge\n- **User Impact:** Developer sees coverage report HTML highlighting uncovered lines in red\n\n#### 3. Accessibility Violation Detected\n- **Description:** WCAG 2.2 Level AA criterion violated (e.g., color contrast too low)\n- **Handling:**\n  1. axe-core reports violation with WCAG criterion ID\n  2. Test fails with violation details and help URL\n  3. Provides CSS selector to locate offending element\n- **User Impact:** Developer sees specific element, violation type, and link to WCAG docs\n\n#### 4. Doc Test Compilation Failure\n- **Description:** `error[E0460]: found possibly newer version of crate keyrx_core`\n- **Handling:**\n  1. Run `cargo clean` to remove stale artifacts\n  2. Run `cargo build --workspace` to rebuild fresh\n  3. Retry doc tests with `cargo test --doc`\n- **User Impact:** Automated script handles cleanup, developer sees \"Doc tests fixed\" message\n\n#### 5. MonacoEditor Test Context Error\n- **Description:** 36 MonacoEditor tests fail with missing WasmProvider\n- **Handling:**\n  1. Bulk fix: Update `MonacoEditor.test.tsx` to wrap all test cases\n  2. Use `renderWithProviders` helper for consistent setup\n  3. Verify all 36 tests pass after fix\n- **User Impact:** Developer runs `npm test MonacoEditor` and sees 36/36 passing\n\n## Testing Strategy\n\n### Unit Testing\n\n**Approach:**\n- Test each component in isolation with mocked dependencies\n- Use `renderWithProviders` for context injection\n- Mock WASM modules with stub implementations\n\n**Key Components to Test:**\n- **MonacoEditor**: Validation logic, error handling, syntax highlighting\n- **Test Helpers**: `renderWithProviders`, `WasmProviderWrapper`\n- **Coverage Tool Configuration**: Verify thresholds are enforced\n\n**Example Test Pattern:**\n```typescript\nimport { renderWithProviders } from '../tests/testUtils';\nimport { MonacoEditor } from './MonacoEditor';\n\ndescribe('MonacoEditor', () => {\n  it('renders with WASM context', () => {\n    const { getByRole } = renderWithProviders(\n      <MonacoEditor value=\"\" onChange={() => {}} />,\n      { wrapWithWasm: true }\n    );\n    expect(getByRole('textbox')).toBeInTheDocument();\n  });\n});\n```\n\n### Integration Testing\n\n**Approach:**\n- Test interaction between components and services\n- Use real WASM modules (not mocked)\n- Verify data flow through React Query cache\n\n**Key Flows to Test:**\n- **Config Editor Workflow**: Load profile → Edit config → WASM validation → Save\n- **Profile Activation**: Click activate → Compile .rhai → Reload daemon → UI updates\n- **Auto-Save**: Change device layout → Debounce → API call → Success feedback\n\n**Example Integration Test:**\n```typescript\ndescribe('Config Editor Integration', () => {\n  it('validates config with WASM before save', async () => {\n    const { getByText, user } = renderWithProviders(<ConfigPage />);\n\n    await user.type(getByRole('textbox'), 'invalid syntax');\n\n    await waitFor(() => {\n      expect(getByText(/syntax error/i)).toBeInTheDocument();\n    });\n  });\n});\n```\n\n### End-to-End Testing\n\n**Approach:**\n- Use Playwright to test full user workflows\n- Test in real browser environment with daemon running\n- Verify accessibility in E2E tests\n\n**User Scenarios to Test:**\n1. **Test Failure Regression**: Run frontend tests, verify ≥95% pass rate\n2. **Coverage Gate**: Run coverage tool, verify ≥80% coverage\n3. **Accessibility Audit**: Open each page, run axe-core, verify zero violations\n4. **Doc Tests**: Run `cargo test --doc`, verify all pass\n\n**Example E2E Test:**\n```typescript\ntest('accessibility audit passes on all pages', async ({ page }) => {\n  const pages = ['/dashboard', '/devices', '/profiles', '/config', '/metrics'];\n\n  for (const path of pages) {\n    await page.goto(`http://localhost:9867${path}`);\n    const violations = await injectAxe(page);\n    expect(violations.length).toBe(0);\n  }\n});\n```\n\n### Meta-Testing Approach\n\n**Special consideration:** This spec is about fixing tests, which creates a meta-testing challenge.\n\n**Strategy:**\n1. **Baseline Verification**: Run tests BEFORE fixes to document failures\n2. **Incremental Fixes**: Fix one test suite at a time, verify improvement\n3. **Regression Prevention**: After each fix, run full suite to ensure no new failures\n4. **Documentation**: Log each fix with before/after test counts\n\n**Quality Gates:**\n- Phase 1: Fix tests → Verify pass rate ≥95%\n- Phase 2: Add coverage → Verify metrics ≥80%\n- Phase 3: Add accessibility → Verify zero violations\n- Phase 4: Fix doc tests → Verify 100% compilation success\n",
  "fileStats": {
    "size": 14175,
    "lines": 450,
    "lastModified": "2026-01-02T14:50:20.141Z"
  },
  "comments": []
}