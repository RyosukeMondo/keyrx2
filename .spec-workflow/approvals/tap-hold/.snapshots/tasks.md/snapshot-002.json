{
  "id": "snapshot_1766587813324_g3xq816xh",
  "approvalId": "approval_1766464355054_f361gi5uw",
  "approvalTitle": "Tap-Hold Tasks Document",
  "version": 2,
  "timestamp": "2025-12-24T14:50:13.324Z",
  "trigger": "approved",
  "status": "pending",
  "content": "# Tasks Document: Tap-Hold Functionality\n\n## Phase 1: Core Infrastructure\n\n- [x] 1. Add timestamp field to KeyEvent structure\n  - File: `keyrx_core/src/runtime/event.rs`\n  - Add `timestamp_us: u64` field to KeyEvent struct\n  - Update all KeyEvent constructors to accept timestamp\n  - Add `KeyEvent::with_timestamp()` helper\n  - Purpose: Enable timing-based decisions in event processing\n  - _Leverage: keyrx_core/src/runtime/event.rs (existing KeyEvent)_\n  - _Requirements: 4.3, 4.4_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer specializing in no_std embedded systems | Task: Add timestamp_us field to KeyEvent struct in keyrx_core/src/runtime/event.rs, update constructors, ensure no_std compatibility | Restrictions: Must maintain no_std, no heap allocation, backward compatible with existing code | Success: KeyEvent has timestamp field, all existing code compiles, no performance regression | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n- [x] 2. Create Clock trait for time abstraction\n  - File: `keyrx_core/src/runtime/clock.rs` (new file)\n  - Define Clock trait with `now(&self) -> u64` method\n  - Implement SystemClock (uses timestamp from events)\n  - Implement VirtualClock for testing (manually advanceable)\n  - Purpose: Enable deterministic testing with virtual time\n  - _Leverage: None (new abstraction)_\n  - _Requirements: 4.1, 4.2_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with testing expertise | Task: Create Clock trait in new file keyrx_core/src/runtime/clock.rs with SystemClock and VirtualClock implementations | Restrictions: Must be no_std compatible, VirtualClock must be thread-safe for parallel tests | Success: Clock trait defined, both implementations work, VirtualClock can advance time programmatically | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n- [x] 3. Create TapHoldState enum and struct\n  - File: `keyrx_core/src/runtime/tap_hold.rs` (new file)\n  - Define TapHoldPhase enum: Idle, Pending, Hold\n  - Define TapHoldState struct with key, phase, config fields\n  - Implement state transition methods\n  - Purpose: Represent individual tap-hold key state\n  - _Leverage: keyrx_core/src/config/mappings.rs (BaseKeyMapping::TapHold)_\n  - _Requirements: 3.1, 3.2, 3.4_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with state machine expertise | Task: Create TapHoldPhase enum and TapHoldState struct in new file keyrx_core/src/runtime/tap_hold.rs with state transition logic | Restrictions: Use Copy types only, no heap, match existing code style | Success: State transitions are clear and tested, no invalid state combinations possible | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n## Phase 2: State Machine Implementation\n\n- [x] 4. Implement PendingKeyRegistry\n  - File: `keyrx_core/src/runtime/tap_hold.rs` (extend)\n  - Create PendingKeyRegistry<const N: usize> using ArrayVec\n  - Implement add, remove, get, get_mut, iter methods\n  - Implement check_timeouts for batch timeout processing\n  - Purpose: Track multiple concurrent tap-hold keys\n  - _Leverage: arrayvec crate (already in dependencies)_\n  - _Requirements: 3.3_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer specializing in embedded collections | Task: Implement PendingKeyRegistry using ArrayVec in keyrx_core/src/runtime/tap_hold.rs with O(n) lookup but cache-friendly iteration | Restrictions: Max 32 concurrent tap-holds, no heap, handle registry full gracefully | Success: Registry works with concurrent keys, timeout checking is efficient | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n- [x] 5. Implement TapHoldProcessor core logic\n  - File: `keyrx_core/src/runtime/tap_hold.rs` (extend)\n  - Create TapHoldProcessor struct\n  - Implement process_event() for Press, Release, Repeat handling\n  - Implement state transitions: Idle→Pending, Pending→Hold, Pending→Tap, Hold→Idle\n  - Purpose: Central tap-hold event processing\n  - _Leverage: keyrx_core/src/runtime/state.rs (DeviceState)_\n  - _Requirements: 1.1, 1.2, 1.3, 3.1, 3.2_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with DFA/state machine expertise | Task: Implement TapHoldProcessor with process_event method handling all state transitions in keyrx_core/src/runtime/tap_hold.rs | Restrictions: Return ArrayVec of output events, integrate with DeviceState for modifier management | Success: All state transitions work correctly, output events match expected tap/hold behavior | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n- [x] 6. Implement Permissive Hold logic\n  - File: `keyrx_core/src/runtime/tap_hold.rs` (extend)\n  - Detect other key press while in Pending state\n  - Immediately transition to Hold when interrupted\n  - Activate hold modifier before processing interrupting key\n  - Purpose: Enable natural typing flow with tap-hold keys\n  - _Leverage: Task 5 (TapHoldProcessor)_\n  - _Requirements: 3.1_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with keyboard firmware experience | Task: Add Permissive Hold logic to TapHoldProcessor - when any other key is pressed while tap-hold is Pending, immediately confirm Hold | Restrictions: Must activate modifier before returning so interrupting key sees active modifier | Success: Typing \"CapsLock(hold)+A\" produces Ctrl+A even if A pressed before threshold | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n## Phase 3: Integration\n\n- [x] 7. Integrate TapHoldProcessor into process_event\n  - File: `keyrx_core/src/runtime/event.rs`\n  - Import and instantiate TapHoldProcessor\n  - Replace stubbed TapHold match arm with processor call\n  - Pass timestamp and state to processor\n  - Purpose: Activate tap-hold in main event pipeline\n  - _Leverage: keyrx_core/src/runtime/tap_hold.rs, keyrx_core/src/runtime/event.rs_\n  - _Requirements: 1.1, 1.2, 1.3, 5.1_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with integration expertise | Task: Replace stubbed TapHold branch in process_event with actual TapHoldProcessor call in keyrx_core/src/runtime/event.rs | Restrictions: Maintain existing function signature, no breaking changes to other mapping types | Success: TapHold mappings now produce output events instead of empty vector | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n- [x] 8. Pass timestamps from daemon to core\n  - File: `keyrx_daemon/src/platform/linux.rs`\n  - Extract timestamp from evdev event\n  - Convert to microseconds and pass to KeyEvent\n  - Handle missing timestamps gracefully\n  - Purpose: Provide accurate timing data to tap-hold processor\n  - _Leverage: evdev crate timestamp API_\n  - _Requirements: 4.3, 4.4_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with Linux evdev experience | Task: Extract timestamps from evdev events in keyrx_daemon/src/platform/linux.rs and pass to KeyEvent constructor | Restrictions: Handle missing timestamps by falling back to monotonic clock, no panics | Success: KeyEvents from Linux have accurate timestamps in microseconds | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n- [x] 9. Add timer checking to daemon event loop\n  - File: `keyrx_daemon/src/daemon/mod.rs`\n  - Call check_timeouts() periodically (every 10ms or on event)\n  - Process timeout-triggered Hold activations\n  - Inject resulting events into output\n  - Purpose: Detect threshold crossing for held keys\n  - _Leverage: keyrx_core/src/runtime/tap_hold.rs (check_timeouts)_\n  - _Requirements: 3.2_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Rust Developer with async/event loop expertise | Task: Add periodic check_timeouts call to daemon event loop in keyrx_daemon/src/daemon/mod.rs for threshold detection | Restrictions: Use non-blocking timeout check, batch process multiple timeouts | Success: Keys held past threshold activate Hold even without release event | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n## Phase 4: Testing\n\n- [x] 10. Unit tests for state machine\n  - File: `keyrx_core/src/runtime/tap_hold.rs` (tests module)\n  - Test Tap path: Press → Release(quick) → outputs tap key\n  - Test Hold path: Press → timeout → Hold active → Release → deactivate\n  - Test edge cases: exact threshold, threshold ± 1μs\n  - Purpose: Verify state machine correctness\n  - _Leverage: VirtualClock from Task 2_\n  - _Requirements: 1.1, 1.2, 1.3, 4.1_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer with Rust testing expertise | Task: Write comprehensive unit tests for TapHoldProcessor in keyrx_core/src/runtime/tap_hold.rs covering tap, hold, and edge cases | Restrictions: Use VirtualClock for determinism, test both success and error paths | Success: 100% branch coverage on state machine, all timing edge cases covered | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n- [x] 11. Unit tests for Permissive Hold\n  - File: `keyrx_core/src/runtime/tap_hold.rs` (tests module)\n  - Test interrupted tap-hold confirms Hold immediately\n  - Test modifier active before interrupted key processed\n  - Test multiple concurrent tap-holds with interruption\n  - Purpose: Verify Permissive Hold behavior\n  - _Leverage: VirtualClock, Task 10 test patterns_\n  - _Requirements: 3.1, 3.3_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Engineer with keyboard behavior expertise | Task: Write unit tests for Permissive Hold behavior - interrupting key press immediately confirms Hold | Restrictions: Verify modifier state before processing interrupting key | Success: Permissive Hold works correctly in all tested scenarios | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n- [x] 12. Integration tests with compiled configs\n  - File: `keyrx_core/tests/tap_hold_integration.rs` (new file)\n  - Compile example tap_hold config to .krx\n  - Load config and process simulated events\n  - Verify correct output events\n  - Purpose: Test full pipeline from config to output\n  - _Leverage: keyrx_compiler, examples/04-dual-function-keys.rhai_\n  - _Requirements: 2.1, 2.4, 5.1, 5.4_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Integration Test Engineer | Task: Create integration tests that compile tap_hold Rhai config, load .krx, and verify event processing in keyrx_core/tests/tap_hold_integration.rs | Restrictions: Use real compiler output, test realistic key sequences | Success: Integration tests pass with compiled configs, end-to-end behavior verified | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n- [x] 13. Property-based tests for determinism\n  - File: `keyrx_core/tests/tap_hold_proptest.rs` (new file)\n  - Generate random key event sequences\n  - Verify same sequence always produces same output\n  - Test with varying thresholds and timing\n  - Purpose: Ensure deterministic behavior under all inputs\n  - _Leverage: proptest crate_\n  - _Requirements: 4.1_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Property-Based Testing Expert | Task: Create proptest-based tests verifying tap-hold determinism - same input always produces same output | Restrictions: Use VirtualClock, generate realistic key sequences, run 10K+ cases | Success: No determinism violations found in 100K generated test cases | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n## Phase 5: Virtual E2E and Documentation\n\n- [x] 14. Virtual E2E tests for tap-hold\n  - File: `keyrx_daemon/tests/tap_hold_e2e.rs` (new file)\n  - Use VirtualKeyboard to inject tap-hold key presses\n  - Use OutputCapture to verify output timing and keys\n  - Test realistic usage patterns\n  - Purpose: Verify end-to-end behavior with virtual devices\n  - _Leverage: keyrx_daemon/src/test_utils/ (VirtualKeyboard, OutputCapture)_\n  - _Requirements: 1.1, 1.2, 3.1, 5.3_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: E2E Test Engineer | Task: Create virtual E2E tests for tap-hold using VirtualKeyboard and OutputCapture in keyrx_daemon/tests/tap_hold_e2e.rs | Restrictions: Use skip_if_no_uinput macro for CI compatibility, test realistic sequences | Success: E2E tests pass locally with uinput access, skip gracefully in CI | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n- [x] 15. Update example configurations\n  - File: `examples/04-dual-function-keys.rhai`\n  - Verify example works with new implementation\n  - Add comments explaining tap vs hold behavior\n  - Add edge case examples (multiple tap-holds, nested conditions)\n  - Purpose: Provide working reference configurations\n  - _Leverage: Existing example file_\n  - _Requirements: 2.1, 2.4_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Technical Writer with keyboard expertise | Task: Update examples/04-dual-function-keys.rhai with working tap-hold examples and comprehensive comments | Restrictions: Ensure examples compile and work correctly, explain behavior clearly | Success: Example file is self-documenting, all configurations work as described | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n- [x] 16. Add debug logging for state transitions\n  - File: `keyrx_core/src/runtime/tap_hold.rs`\n  - Add trace-level logging for state transitions\n  - Include key, old state, new state, elapsed time\n  - Compile out in release mode (cfg(debug_assertions))\n  - Purpose: Enable debugging of tap-hold behavior\n  - _Leverage: log crate (already in dependencies)_\n  - _Requirements: Non-functional (Usability)_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Observability Engineer | Task: Add debug logging to TapHoldProcessor state transitions with key, state change, and timing info | Restrictions: Use trace! level, compile out in release, no performance impact in production | Success: Debug mode shows clear state transition logs, release mode has no overhead | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n## Phase 6: Final Verification\n\n- [x] 17. Run full test suite and verify coverage\n  - Files: All test files\n  - Run cargo test with coverage\n  - Verify 80%+ coverage on tap_hold.rs\n  - Fix any failing tests\n  - Purpose: Ensure quality meets standards\n  - _Leverage: cargo tarpaulin_\n  - _Requirements: All_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Lead | Task: Run full test suite with coverage, verify 80%+ on tap_hold module, fix any issues | Restrictions: All tests must pass, coverage threshold must be met | Success: All tests green, coverage >= 80%, no regressions in other modules | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n\n- [x] 18. Manual UAT with real keyboard\n  - Files: None (manual testing)\n  - Build release daemon with tap-hold config\n  - Test CapsLock as tap=Escape, hold=Ctrl\n  - Verify timing feels natural (200ms threshold)\n  - Purpose: Validate user experience\n  - _Leverage: examples/04-dual-function-keys.rhai_\n  - _Requirements: 1.1, 1.2, 1.3_\n  - _Prompt: Implement the task for spec tap-hold, first run spec-workflow-guide to get the workflow guide then implement the task: Role: User Experience Tester | Task: Perform manual UAT with real keyboard - test CapsLock tap-hold behavior, verify natural feel | Restrictions: Document any timing issues, suggest threshold adjustments if needed | Success: Tap-hold feels natural and responsive, no stuck modifiers, no missed inputs | Instructions: Set task status to [-] in tasks.md before starting, use log-implementation tool after completion with detailed artifacts, then mark [x] when done_\n",
  "fileStats": {
    "size": 18589,
    "lines": 194,
    "lastModified": "2025-12-23T09:21:19.642Z"
  },
  "comments": []
}