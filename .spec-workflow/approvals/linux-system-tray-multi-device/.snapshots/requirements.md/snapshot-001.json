{
  "id": "snapshot_1766594492552_jowxcz7c5",
  "approvalId": "approval_1766594492547_umydix3ze",
  "approvalTitle": "Linux System Tray + Multi-Device Requirements",
  "version": 1,
  "timestamp": "2025-12-24T16:41:32.552Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nThis specification adds two critical features to the Linux platform to achieve parity with Windows and unlock the \"keyboard-aware remapping\" market positioning:\n\n1. **System Tray Integration**: Implement system tray icon with Reload/Exit controls (matching Windows functionality)\n2. **Multi-Device Event Discrimination**: Expose device serial numbers in KeyEvent to enable per-device configuration (e.g., \"turn your $12 numpad into a $150 Stream Deck\")\n\nThese features enable users to:\n- Control the daemon via GUI (reload configs, exit gracefully) without CLI\n- Configure different remapping rules per physical keyboard (main keyboard vs USB numpad vs macro pad)\n- Identify which keyboard sent which keystroke for advanced workflows\n\n## Alignment with Product Vision\n\nThis feature directly supports the product vision outlined in `.spec-workflow/steering/product.md`:\n\n### Multi-Device Support (Product Goal #7)\n> **\"N:M device-to-configuration mapping\"**: Multiple keyboards, modular configs with **\"Serial number-based identification\"**\n\nThis spec implements the Linux side of true per-device configuration, filling the gap left by competitors:\n- **vs Karabiner-Elements**: Karabiner lacks serial number support (open issue #2007)\n- **vs kmonad**: No per-device support (open issue #318 since 2021)\n- **vs xremap**: Linux-only and limited to YAML static rules\n\n### Platform Parity\nWindows already has system tray (via `tray.rs`). This spec brings Linux to feature parity, enabling:\n- Consistent UX across platforms\n- Code reuse through platform trait abstraction\n- Professional deployment (no CLI-only limitation)\n\n## Requirements\n\n### Requirement 1: Cross-Platform System Tray Abstraction\n\n**User Story:** As a developer, I want a platform-agnostic SystemTray trait so that Linux and Windows can share tray icon logic without duplication.\n\n#### Acceptance Criteria\n\n1. WHEN implementing system tray THEN code SHALL define a `SystemTray` trait in `keyrx_daemon/src/platform/mod.rs`\n2. WHEN trait is defined THEN it SHALL include methods: `new()`, `poll_event() -> Option<TrayControlEvent>`, and shutdown cleanup\n3. WHEN Windows tray is refactored THEN it SHALL implement the `SystemTray` trait with no behavior changes\n4. IF either platform's tray emits Reload or Exit events THEN the daemon's main loop SHALL handle them identically\n\n### Requirement 2: Linux System Tray Implementation\n\n**User Story:** As a Linux user, I want a system tray icon for keyrx_daemon so that I can reload configuration and exit the daemon without using the terminal.\n\n#### Acceptance Criteria\n\n1. WHEN daemon starts on Linux THEN a tray icon SHALL appear in the system tray with label \"KeyRx Daemon\"\n2. WHEN user right-clicks the tray icon THEN a context menu SHALL display with options: \"Reload Config\", separator, \"Exit\"\n3. WHEN user clicks \"Reload Config\" THEN daemon SHALL reload the .krx configuration file and apply changes without restart\n4. WHEN user clicks \"Exit\" THEN daemon SHALL release grabbed devices, cleanup resources, and terminate gracefully within 500ms\n5. IF system tray is unavailable (headless server) THEN daemon SHALL log warning and continue without tray (degraded mode)\n6. WHEN daemon exits THEN tray icon SHALL be removed from system tray automatically\n\n### Requirement 3: Device ID in KeyEvent Structure\n\n**User Story:** As a developer, I want KeyEvent to include a device identifier so that the remapping engine can apply different rules per physical keyboard.\n\n#### Acceptance Criteria\n\n1. WHEN KeyEvent is created THEN it SHALL include an optional `device_id: Option<String>` field\n2. WHEN device_id is None THEN remapping engine SHALL use default configuration (backward compatible)\n3. WHEN device_id is Some(id) THEN Rhai scripts SHALL access it via `event.device_id()` function\n4. IF KeyEvent is created without device info THEN device_id SHALL default to None (no breakage of existing code)\n\n### Requirement 4: Linux Device Enumeration and ID Tracking\n\n**User Story:** As a Linux user, I want keyrx to distinguish between my laptop keyboard and my USB numpad so that I can configure them independently (e.g., numpad as macro pad).\n\n#### Acceptance Criteria\n\n1. WHEN daemon starts on Linux THEN it SHALL enumerate all keyboard devices in `/dev/input/by-id/` or `/dev/input/event*`\n2. WHEN opening each device THEN daemon SHALL extract serial number via `EvdevInput::serial()` (or generate fallback ID if serial unavailable)\n3. WHEN device sends key event THEN the event SHALL be tagged with the device's serial number as `device_id`\n4. IF device has no serial number THEN daemon SHALL use device path (e.g., `/dev/input/event3`) as stable identifier\n5. WHEN user connects new USB keyboard THEN daemon SHALL detect it and add to device list (hot-plug support is future, not required for v1)\n\n### Requirement 5: Device Information in Web UI\n\n**User Story:** As a user, I want to see which keyboards are currently active in the web dashboard so that I can verify my device-specific configuration is applied to the correct keyboard.\n\n#### Acceptance Criteria\n\n1. WHEN user opens web UI THEN a \"Connected Devices\" section SHALL display list of all input devices\n2. WHEN device is active THEN its entry SHALL show: name (e.g., \"Logitech USB Keyboard\"), serial number (if available), device path\n3. WHEN device sends event THEN UI SHALL highlight the device briefly (visual feedback)\n4. IF user has configured device-specific rules THEN UI SHALL display which config applies to each device\n\n### Requirement 6: Rhai API for Device-Specific Configuration\n\n**User Story:** As a power user, I want to write Rhai scripts that check which keyboard sent a keystroke so that I can remap my USB numpad to OBS hotkeys while keeping my main keyboard normal.\n\n#### Acceptance Criteria\n\n1. WHEN Rhai script is evaluated THEN it SHALL have access to `event.device_id()` function returning `Option<String>`\n2. WHEN device_id is available THEN script SHALL use conditional logic: `if event.device_id() == \"USB\\\\SERIAL_NUMPAD\" { /* ... */ }`\n3. WHEN device_id is None THEN script SHALL treat event as coming from default device\n4. IF user configures per-device mapping THEN only that device's events SHALL match the rule (other devices unaffected)\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**:\n  - `platform/tray.rs` (Linux): System tray implementation only\n  - `platform/mod.rs`: SystemTray trait definition, no platform-specific code\n  - `platform/linux/mod.rs`: Device enumeration and ID management\n- **Modular Design**:\n  - System tray code abstracted via trait (Windows and Linux implement same interface)\n  - Device ID tracking isolated in platform layer (core logic unchanged)\n- **Dependency Management**:\n  - Linux tray uses `ksni` crate (KDE StatusNotifierItem) or `libayatana-appindicator` (GTK)\n  - Minimize new dependencies (reuse existing `tray-icon` crate if cross-platform)\n- **Clear Interfaces**:\n  - `SystemTray` trait defines contract for all platforms\n  - `InputDevice::next_event()` returns KeyEvent with device_id populated\n\n### Performance\n- **Latency Impact**: Device ID lookup SHALL add <10μs overhead (string comparison optimized via interning or hash map)\n- **Memory**: Device enumeration SHALL use <1MB additional memory (device list stored once at startup)\n- **Tray Polling**: `poll_event()` SHALL use non-blocking check (<1μs overhead per main loop iteration)\n\n### Reliability\n- **Tray Fallback**: If system tray init fails, daemon SHALL continue without tray (degraded mode, CLI still works)\n- **Device Hot-Plug**: V1 SHALL detect devices at startup only; hot-plug detection is future enhancement\n- **Graceful Shutdown**: Tray \"Exit\" SHALL trigger same cleanup path as SIGTERM (release grabs, flush logs)\n\n### Usability\n- **Tray Icon Design**: Use existing `assets/icon.png` (same as Windows) for visual consistency\n- **Error Messages**: If tray fails on headless server, log: \"System tray unavailable (headless environment), use CLI to control daemon\"\n- **Device Naming**: Show human-readable device names (from evdev) + serial in UI, not just paths\n",
  "fileStats": {
    "size": 8181,
    "lines": 135,
    "lastModified": "2025-12-24T16:41:26.359Z"
  },
  "comments": []
}