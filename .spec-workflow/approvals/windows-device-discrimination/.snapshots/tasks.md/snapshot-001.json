{
  "id": "snapshot_1766594947443_jp1ll9nw4",
  "approvalId": "approval_1766594947438_xw3arrc3f",
  "approvalTitle": "Windows Device Discrimination Tasks",
  "version": 1,
  "timestamp": "2025-12-24T16:49:07.443Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\n\n- [ ] 1. Create DeviceMap module for handle-to-serial mapping\n  - File: keyrx_daemon/src/platform/windows/device_map.rs (new file)\n  - Define DeviceInfo struct with handle, device_id, name, path fields\n  - Implement DeviceMap with HashMap cache for O(1) lookup\n  - Implement enumerate_devices() using GetRawInputDeviceList\n  - Implement get_device_id() with caching and fallback\n  - Implement extract_serial_from_path() helper function\n  - Purpose: Map Windows device handles to stable serial-based identifiers\n  - _Leverage: windows-sys Win32::Devices::HumanInterfaceDevice APIs_\n  - _Requirements: 2.1, 2.2, 3.1, 3.2, 3.3, 3.4, 7.1, 7.2_\n  - _Prompt: Role: Windows Systems Developer with expertise in HID APIs and device enumeration | Task: Implement DeviceMap module following requirements 2.1-3.4 and 7.1-7.2, using GetRawInputDeviceList and GetRawInputDeviceInfo to map device handles to serial numbers | Restrictions: Must cache device info for O(1) lookup, handle missing serial numbers gracefully (use path fallback), parse device paths correctly (format: \\\\?\\HID#VID&PID#Serial#{GUID}), limit cache to 50 devices max | Success: DeviceMap enumerates all keyboards, get_device_id() returns serial or fallback, cache hits are <10ns, unit tests cover serial extraction and fallback logic_\n\n- [ ] 2. Create RawInputManager for WM_INPUT event processing\n  - File: keyrx_daemon/src/platform/windows/rawinput.rs (new file)\n  - Create hidden window for receiving WM_INPUT messages\n  - Implement RegisterRawInputDevices with RIDEV_INPUTSINK and RIDEV_NOLEGACY\n  - Implement window_proc for WM_INPUT message handling\n  - Extract hDevice and VK code from RAWINPUT structure\n  - Send (KeyEvent, device_id) via crossbeam_channel\n  - Implement shutdown to unregister raw input\n  - Purpose: Replace WH_KEYBOARD_LL hooks with Raw Input API\n  - _Leverage: DeviceMap from task 1, keycode::vk_to_keycode() for VK translation_\n  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4_\n  - _Prompt: Role: Windows API Expert with expertise in Raw Input and Win32 message loops | Task: Implement RawInputManager following requirements 1.1-2.4, creating hidden window for WM_INPUT messages and extracting device handles | Restrictions: Must use RIDEV_INPUTSINK for background capture, filter injected events (check dwFlags for MOUSE_MOVE_RELATIVE), ensure <100μs processing time in window_proc, call DefWindowProcW for unhandled messages | Success: RegisterRawInputDevices succeeds, WM_INPUT messages received, hDevice extracted correctly, events sent to channel with <100μs latency, graceful shutdown unregisters devices_\n\n- [ ] 3. Refactor WindowsKeyboardInput to use RawInputManager\n  - File: keyrx_daemon/src/platform/windows/input.rs\n  - Replace hook-based implementation with RawInputManager\n  - Update grab() to create RawInputManager instance\n  - Update next_event() to receive from channel and attach device_id\n  - Update release() to shutdown RawInputManager\n  - Remove dependency on hook.rs (will be deleted in task 5)\n  - Purpose: Adapt InputDevice trait to use Raw Input backend\n  - _Leverage: RawInputManager from task 2, KeyEvent::with_device_id() from Spec 1_\n  - _Requirements: 2.4_\n  - _Prompt: Role: Rust Developer with expertise in trait implementation and Windows platform integration | Task: Refactor WindowsKeyboardInput to use RawInputManager following requirement 2.4, replacing hook-based event capture | Restrictions: Must maintain InputDevice trait contract exactly, preserve error handling semantics, ensure backward compatibility (existing code using InputDevice sees no API changes), handle channel disconnection gracefully | Success: WindowsKeyboardInput compiles, implements InputDevice trait, events include device_id, no breaking changes to public API, existing tests pass_\n\n- [ ] 4. Add WM_INPUT_DEVICE_CHANGE handling for hot-plug\n  - File: keyrx_daemon/src/platform/windows/rawinput.rs (modify from task 2)\n  - Add WM_INPUT_DEVICE_CHANGE case to window_proc\n  - Detect GIDC_ARRIVAL (device connected) and GIDC_REMOVAL (device disconnected)\n  - Refresh DeviceMap when device list changes\n  - Log device additions/removals at INFO level\n  - Purpose: Automatically detect USB keyboard connect/disconnect\n  - _Leverage: DeviceMap::refresh() method_\n  - _Requirements: 8.1, 8.2, 8.3, 8.4, 8.5_\n  - _Prompt: Role: Windows Device Driver Developer with expertise in hot-plug notification handling | Task: Implement WM_INPUT_DEVICE_CHANGE handling following requirements 8.1-8.5 to detect keyboard hot-plug events | Restrictions: Must not block window_proc (refresh should be fast <1ms), handle spurious notifications gracefully, log device name and ID when added/removed, update web UI device list via internal event | Success: WM_INPUT_DEVICE_CHANGE messages received, DeviceMap refreshes on arrival/removal, new devices immediately usable, daemon continues if device unplugged, logs show device changes_\n\n- [ ] 5. Delete WH_KEYBOARD_LL hook implementation\n  - File: keyrx_daemon/src/platform/windows/hook.rs (delete file)\n  - Remove hook.rs from mod.rs\n  - Remove any remaining references to WindowsKeyboardHook\n  - Update Cargo.toml if hook-specific dependencies existed\n  - Purpose: Clean up obsolete Low-Level Hook code\n  - _Leverage: None (pure deletion)_\n  - _Requirements: 1.4_\n  - _Prompt: Role: Rust Developer specializing in code cleanup and refactoring | Task: Delete obsolete hook.rs file following requirement 1.4 after verifying RawInputManager replacement is complete | Restrictions: Must verify no remaining references to hook.rs code exist (grep for \"hook::\" or \"WindowsKeyboardHook\"), update mod.rs to remove module declaration, ensure all tests pass without hook code | Success: hook.rs deleted, no compilation errors, no references to old hook code remain, all tests pass_\n\n- [ ] 6. Update WindowsPlatform to use new input implementation\n  - File: keyrx_daemon/src/platform/windows/mod.rs\n  - Ensure WindowsPlatform::init() works with new RawInputManager\n  - Ensure process_events() runs message loop if needed\n  - Verify system tray continues to work (unchanged)\n  - Purpose: Integrate refactored input system into platform struct\n  - _Leverage: Refactored WindowsKeyboardInput from task 3_\n  - _Requirements: 4.1, 4.2_\n  - _Prompt: Role: Platform Integration Engineer with expertise in Windows daemon architecture | Task: Update WindowsPlatform to integrate RawInputManager following requirements 4.1-4.2, ensuring tray and input coexist | Restrictions: Must preserve system tray functionality exactly, ensure message loop processes both WM_INPUT and tray messages, handle init failures gracefully (log error, exit cleanly), maintain public API compatibility | Success: WindowsPlatform compiles, init() succeeds with raw input, process_events() handles both input and tray, existing daemon startup code works unchanged_\n\n- [ ] 7. Add device enumeration logging at startup\n  - File: keyrx_daemon/src/platform/windows/rawinput.rs (modify)\n  - On RawInputManager::new(), enumerate devices via DeviceMap\n  - Log each device: INFO level with name, serial (or fallback ID), handle\n  - If no keyboards detected, return error from new()\n  - Purpose: Provide visibility into which devices are monitored\n  - _Leverage: DeviceMap::enumerate_devices()_\n  - _Requirements: 7.1, 7.2, 7.3_\n  - _Prompt: Role: DevOps Engineer with expertise in logging and operational visibility | Task: Add device enumeration logging following requirements 7.1-7.3, logging all detected keyboards at daemon startup | Restrictions: Use structured logging (JSON format if enabled), log device info at INFO level not DEBUG, include serial number or fallback ID, fail gracefully if no keyboards found (return clear error message) | Success: Startup logs show all connected keyboards, each entry includes name and ID, no keyboards triggers error exit, logs are parseable by monitoring tools_\n\n- [ ] 8. Extend /api/devices endpoint for Windows\n  - File: keyrx_daemon/src/web/api.rs (modify from Spec 1 task 8)\n  - Update /api/devices to work on Windows platform\n  - Query DeviceMap for device list on Windows\n  - Return same JSON format as Linux (id, name, path, serial, active)\n  - Purpose: Cross-platform device listing in web UI\n  - _Leverage: DeviceMap::enumerate_devices(), existing /api/devices from Spec 1_\n  - _Requirements: 7.4_\n  - _Prompt: Role: Full-stack Developer with expertise in cross-platform API design | Task: Extend /api/devices endpoint to support Windows platform following requirement 7.4, returning device list from DeviceMap | Restrictions: Must use same JSON schema as Linux implementation, handle platform differences transparently (Linux: evdev paths, Windows: HID paths), ensure endpoint works when called from React frontend, return empty array if no devices | Success: GET /api/devices works on Windows, returns valid JSON matching Linux schema, device list populated from DeviceMap, frontend displays Windows devices correctly_\n\n- [ ] 9. Write unit tests for DeviceMap\n  - File: keyrx_daemon/src/platform/windows/device_map.rs (add #[cfg(test)] mod tests)\n  - Test extract_serial_from_path() with real Windows device path examples\n  - Test cache hit/miss (first lookup queries API, second uses cache)\n  - Test fallback ID generation when serial unavailable\n  - Test device enumeration (may need mock or real hardware)\n  - Purpose: Ensure device mapping is reliable\n  - _Leverage: None (pure testing)_\n  - _Requirements: All DeviceMap-related requirements_\n  - _Prompt: Role: QA Engineer specializing in Windows platform testing and mocking | Task: Write comprehensive unit tests for DeviceMap covering serial extraction, caching, and fallback logic | Restrictions: Mock GetRawInputDeviceInfo where possible to avoid hardware dependency, test edge cases (empty path, malformed path, null handle), verify cache performance (O(1) after first lookup), ensure tests run on CI | Success: All DeviceMap functions tested, serial extraction handles real Windows paths, cache tests verify O(1) lookup, fallback tests cover missing serial scenario, 90%+ coverage_\n\n- [ ] 10. Write integration tests for RawInputManager\n  - File: keyrx_daemon/src/platform/windows/rawinput.rs (add #[cfg(test)] mod tests)\n  - Test RegisterRawInputDevices success and failure cases\n  - Test WM_INPUT message parsing (may need test harness to inject messages)\n  - Test event channel receives events with correct device_id\n  - Test hot-plug handling (WM_INPUT_DEVICE_CHANGE)\n  - Purpose: Verify Raw Input event pipeline works end-to-end\n  - _Leverage: Windows test utilities, mock message injection_\n  - _Requirements: All RawInputManager-related requirements_\n  - _Prompt: Role: Windows Platform Test Engineer with expertise in Win32 API testing | Task: Write integration tests for RawInputManager covering event processing and hot-plug handling | Restrictions: Tests must run without real keyboards if possible (use virtual HID or message injection), verify channel receives events, test shutdown cleanup, ensure tests don't require administrator privileges unless necessary | Success: RawInputManager tests cover registration, message handling, hot-plug, shutdown; events verified in channel; tests pass consistently in CI_\n\n- [ ] 11. Performance benchmarks for Raw Input vs LL Hooks\n  - File: keyrx_daemon/benches/input_latency.rs (new file or modify existing)\n  - Measure latency: hardware event → KeyEvent in channel\n  - Compare Raw Input implementation to baseline (if LL Hooks still available for comparison)\n  - Verify <100μs processing time (p50, p95, p99 percentiles)\n  - Document results in benchmark report\n  - Purpose: Verify performance meets requirements\n  - _Leverage: criterion crate for benchmarking_\n  - _Requirements: 5.1, 5.2, 5.3, 5.4_\n  - _Prompt: Role: Performance Engineer with expertise in Windows timing APIs and benchmarking | Task: Create performance benchmarks following requirements 5.1-5.4, measuring Raw Input latency and comparing to baseline | Restrictions: Use QueryPerformanceCounter for microsecond timing, run benchmarks with real keyboard input (may need manual trigger), measure multiple percentiles (p50/p95/p99), compare against <1ms requirement, document methodology | Success: Benchmark shows <1ms end-to-end latency, p50 <100μs, p95 <500μs, results documented with comparison to LL Hooks baseline if available_\n\n- [ ] 12. Update Windows platform documentation\n  - File: docs/windows-setup.md (new or modify existing)\n  - Document Raw Input API usage (removed LL Hooks)\n  - Document administrator privilege requirement for RIDEV_INPUTSINK\n  - Document device identification via serial numbers\n  - Provide troubleshooting for permission errors\n  - Example Rhai config for multi-device setup\n  - Purpose: Guide users through Windows-specific setup\n  - _Leverage: Existing documentation structure_\n  - _Requirements: All_\n  - _Prompt: Role: Technical Writer specializing in Windows system administration | Task: Create comprehensive Windows platform documentation covering Raw Input, permissions, and multi-device configuration | Restrictions: Explain why administrator is required (RIDEV_INPUTSINK for background capture), provide UAC elevation instructions, document serial number extraction for user reference, include troubleshooting section for common errors, use clear screenshots where helpful | Success: Documentation covers Raw Input architecture, admin requirement explained, device identification documented, troubleshooting section comprehensive, example configs provided_\n\n- [ ] 13. End-to-end test: USB numpad as macro pad on Windows\n  - File: keyrx_daemon/tests/e2e_windows_multidevice.rs (new file)\n  - Connect 2 USB keyboards (or use virtual HID for CI)\n  - Configure per-device Rhai rules (numpad → F13, main → passthrough)\n  - Verify events from each device trigger correct remapping\n  - Test hot-plug (disconnect/reconnect numpad during test)\n  - Purpose: Validate complete multi-device workflow\n  - _Leverage: All Windows platform code from tasks 1-12_\n  - _Requirements: All_\n  - _Prompt: Role: QA Automation Engineer with expertise in end-to-end testing and virtual device simulation | Task: Create comprehensive E2E test covering multi-device scenario on Windows following all requirements | Restrictions: May use virtual HID devices for CI (GitHub Actions doesn't have multiple keyboards), test must be deterministic (no timing dependencies), verify Rhai conditional logic works, test hot-plug if possible, document manual testing procedure if automation not feasible | Success: E2E test covers device enumeration, per-device remapping, web UI device list, hot-plug handling; test passes on Windows CI or documented manual procedure provided_\n\n- [ ] 14. Update tech.md steering document\n  - File: .spec-workflow/steering/tech.md\n  - Update Windows section: remove \"Low-Level Hooks\", add \"Raw Input API (RAWINPUT)\"\n  - Document device discrimination architecture (handle → serial mapping)\n  - Update performance claims (lower latency than LL Hooks)\n  - Purpose: Keep steering docs in sync with implementation\n  - _Leverage: Completed implementation from tasks 1-13_\n  - _Requirements: Design alignment_\n  - _Prompt: Role: Technical Architect responsible for architectural documentation | Task: Update tech.md steering document to reflect Raw Input implementation, replacing outdated LL Hooks references | Restrictions: Maintain consistency with product.md and structure.md, update performance metrics based on benchmark results, document architectural decisions (why Raw Input over LL Hooks), keep format consistent with existing structure | Success: tech.md accurately reflects Windows Raw Input architecture, LL Hooks references removed, device discrimination documented, performance claims updated with benchmark data_\n",
  "fileStats": {
    "size": 15826,
    "lines": 156,
    "lastModified": "2025-12-24T16:49:01.308Z"
  },
  "comments": []
}