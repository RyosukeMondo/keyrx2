{
  "id": "snapshot_1766594731533_k46trjqmz",
  "approvalId": "approval_1766594731526_wyupbhxek",
  "approvalTitle": "Windows Device Discrimination Requirements",
  "version": 1,
  "timestamp": "2025-12-24T16:45:31.533Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\n\n## Introduction\n\nThis specification refactors the Windows keyboard input system from Low-Level Hooks (`WH_KEYBOARD_LL`) to Raw Input API (`RAWINPUT`) to enable per-device event discrimination. This unlocks the \"keyboard-aware remapping\" killer feature on Windows, matching Linux's multi-device capabilities.\n\n**Current Limitation:** Windows Low-Level Hooks do not provide device information—all keyboards appear as a single unified input stream. Users cannot configure their USB numpad differently from their main keyboard.\n\n**Solution:** Raw Input API (`RegisterRawInputDevices`, `WM_INPUT`) provides device handles (`HANDLE hDevice`) that map to hardware serial numbers via `GetRawInputDeviceInfo`. This enables device-specific configuration identical to Linux.\n\n**Business Value:** Enables Windows users to repurpose spare keyboards/numpads as macro pads (Stream Deck alternative), a $150+ value proposition using $12 hardware.\n\n## Alignment with Product Vision\n\nThis feature directly supports the product vision outlined in `.spec-workflow/steering/product.md`:\n\n### Multi-Device Support (Product Goal #7)\n> **\"Serial number-based identification\"**: True per-device configs (not USB port-dependent)\n> **\"Industry-first serial number support\"**: Fills gap left by Karabiner-Elements\n\nThis spec achieves serial number discrimination on Windows, completing the cross-platform story:\n- **vs AutoHotkey**: AHK cannot reliably discriminate devices (WH_KEYBOARD_LL limitation)\n- **vs kmonad**: No Windows device discrimination support\n- **vs keyrx (Linux)**: This brings Windows to parity with Linux's evdev serial tracking\n\n### Performance Requirements\n> **\"<1ms end-to-end latency\"**, **\"Sub-millisecond latency processing\"**\n\nRaw Input has **lower latency** than LL Hooks (kernel mode vs user mode callbacks), so this refactor *improves* performance while adding functionality.\n\n## Requirements\n\n### Requirement 1: Replace Low-Level Hooks with Raw Input API\n\n**User Story:** As a Windows developer, I want to replace `WH_KEYBOARD_LL` with `RegisterRawInputDevices` so that the system can identify which keyboard generated each keystroke.\n\n#### Acceptance Criteria\n\n1. WHEN daemon starts on Windows THEN it SHALL call `RegisterRawInputDevices` with `RIDEV_INPUTSINK` and `RIDEV_NOLEGACY` flags\n2. WHEN keyboard event occurs THEN daemon SHALL receive `WM_INPUT` message in window procedure\n3. WHEN processing `WM_INPUT` THEN daemon SHALL call `GetRawInputData` to extract `RAWINPUT` structure\n4. IF hook installation succeeds THEN daemon SHALL NOT fall back to LL Hooks (complete replacement)\n5. WHEN daemon exits THEN it SHALL unregister raw input devices via `RegisterRawInputDevices` with `RIDEV_REMOVE` flag\n\n### Requirement 2: Extract Device Handle from WM_INPUT\n\n**User Story:** As a Windows developer, I want to extract the device handle (`HANDLE hDevice`) from each `WM_INPUT` message so that I can map it to a device serial number.\n\n#### Acceptance Criteria\n\n1. WHEN `WM_INPUT` message is received THEN daemon SHALL extract `RAWINPUT.header.hDevice` handle\n2. WHEN device handle is extracted THEN daemon SHALL store it with the keyboard event\n3. IF `hDevice` is null or invalid THEN daemon SHALL log error and skip the event (do not process)\n4. WHEN event is processed THEN the `hDevice` SHALL be associated with the resulting `KeyEvent`\n\n### Requirement 3: Map Device Handle to Serial Number\n\n**User Story:** As a Windows user, I want each keyboard identified by its USB serial number so that I can write device-specific remapping rules that persist across reboots (not dependent on USB port).\n\n#### Acceptance Criteria\n\n1. WHEN device handle is obtained THEN daemon SHALL call `GetRawInputDeviceInfo` with `RIDI_DEVICENAME` to get device path\n2. WHEN device path is retrieved THEN it SHALL be in format `\\\\?\\HID#VID_XXXX&PID_YYYY#SerialNumber#{GUID}`\n3. WHEN parsing device path THEN daemon SHALL extract the serial number substring\n4. IF serial number is unavailable THEN daemon SHALL use full device path as fallback identifier (stable across sessions)\n5. WHEN device_id is determined THEN it SHALL be added to `KeyEvent` via `with_device_id()` method\n\n### Requirement 4: Maintain System Tray Functionality\n\n**User Story:** As a Windows user, I want the system tray icon to continue working exactly as before so that I can still Reload and Exit via the GUI.\n\n#### Acceptance Criteria\n\n1. WHEN daemon refactor is complete THEN system tray SHALL function identically to current behavior\n2. WHEN user clicks \"Reload Config\" THEN daemon SHALL reload .krx file (no behavior change)\n3. WHEN user clicks \"Exit\" THEN daemon SHALL unregister raw input, cleanup, and terminate gracefully\n4. IF tray implementation uses SystemTray trait (from Spec 1) THEN this refactor SHALL not break that abstraction\n\n### Requirement 5: Performance Equivalence or Improvement\n\n**User Story:** As a competitive gamer, I need <1ms latency so that raw input refactor does not degrade performance compared to LL Hooks.\n\n#### Acceptance Criteria\n\n1. WHEN measuring end-to-end latency THEN raw input SHALL achieve ≤1ms (same or better than LL Hooks)\n2. WHEN benchmarking event processing THEN overhead SHALL be <100μs (target: <50μs)\n3. IF raw input introduces overhead THEN optimizations SHALL be applied (e.g., device handle caching, pre-allocated buffers)\n4. WHEN running performance tests THEN latency percentiles (p50, p95, p99) SHALL not regress compared to baseline\n\n### Requirement 6: Backward Compatibility with Rhai Configs\n\n**User Story:** As a keyrx user, I want existing Rhai configurations to work without modification so that upgrading to device discrimination doesn't break my setup.\n\n#### Acceptance Criteria\n\n1. WHEN existing Rhai config is loaded THEN it SHALL compile and execute without errors (device_id is optional)\n2. WHEN config does not check `device_id` THEN remapping SHALL apply to all devices (current behavior preserved)\n3. WHEN config uses `event.device_id()` conditionals THEN only matching devices SHALL trigger remapping\n4. IF user has single keyboard THEN behavior SHALL be identical to pre-refactor version\n\n### Requirement 7: Device Enumeration at Startup\n\n**User Story:** As a Windows user, I want the daemon to list all connected keyboards at startup so that I can verify which devices are being monitored.\n\n#### Acceptance Criteria\n\n1. WHEN daemon starts THEN it SHALL enumerate all HID keyboard devices via `GetRawInputDeviceList`\n2. WHEN device is enumerated THEN daemon SHALL log: device name, serial number (or fallback ID), device handle\n3. IF no keyboards are detected THEN daemon SHALL log error and exit with code 1 (cannot operate without input)\n4. WHEN device is enumerated THEN its info SHALL be available via `/api/devices` endpoint (matching Linux behavior)\n\n### Requirement 8: Graceful Handling of Device Hot-Plug\n\n**User Story:** As a Windows user, I want the daemon to detect when I plug in a new USB keyboard so that it starts processing events from that device automatically.\n\n#### Acceptance Criteria\n\n1. WHEN USB keyboard is connected THEN daemon SHALL receive `WM_INPUT_DEVICE_CHANGE` notification\n2. WHEN new device is detected THEN daemon SHALL query its info via `GetRawInputDeviceInfo` and add to device list\n3. WHEN device is disconnected THEN daemon SHALL remove it from device list and continue with remaining devices\n4. IF only one keyboard is unplugged THEN daemon SHALL continue operating with other keyboards (no crash)\n5. WHEN device is hot-plugged THEN web UI `/api/devices` SHALL update to reflect new device list\n\n## Non-Functional Requirements\n\n### Code Architecture and Modularity\n- **Single Responsibility Principle**:\n  - `platform/windows/rawinput.rs`: Raw input registration and message handling only\n  - `platform/windows/device_map.rs`: Device handle → serial number mapping only\n  - `platform/windows/hook.rs`: Delete this file (replaced by rawinput.rs)\n- **Modular Design**:\n  - Device mapping logic isolated from event processing (testable independently)\n  - Window procedure separated from input parsing\n- **Dependency Management**:\n  - Only `windows-sys` crate (already in workspace, no new deps)\n  - Use `Win32::UI::Input::KeyboardAndMouse` and `Win32::Devices::HumanInterfaceDevice` modules\n- **Clear Interfaces**:\n  - `InputDevice` trait implementation unchanged (still returns `KeyEvent`)\n  - Device ID propagation via existing `KeyEvent::with_device_id()` (no API changes)\n\n### Performance\n- **Latency**: Raw input SHALL achieve <1ms end-to-end (target: <500μs, better than LL Hooks)\n- **Memory**: Device map SHALL use <100KB (cache device handles → serial numbers, max 10 devices)\n- **CPU**: Raw input processing SHALL use <1% CPU on idle, <5% under sustained input (1000 events/sec)\n\n### Reliability\n- **Fallback**: No fallback to LL Hooks (raw input is superior, if it fails daemon should exit with clear error)\n- **Hot-Plug**: Device connect/disconnect SHALL NOT crash daemon (handled via `WM_INPUT_DEVICE_CHANGE`)\n- **Device Errors**: Invalid `hDevice` or `GetRawInputDeviceInfo` failure SHALL log warning and skip event (do not crash)\n\n### Usability\n- **Device Naming**: Log human-readable device names (from `RIDI_DEVICENAME`) at startup\n- **Error Messages**: If raw input registration fails, log: \"Failed to register raw input (error code: XXX). Try running as Administrator.\"\n- **Migration**: Document breaking change (LL Hooks removed) in release notes, explain why (device discrimination)\n\n### Security\n- **Injected Event Filtering**: Raw input SHALL ignore `RIM_INPUT_SINK` flag to avoid processing injected events (prevents infinite loops)\n- **Administrator Privileges**: Raw input with `RIDEV_INPUTSINK` requires admin on some Windows versions—document this requirement\n",
  "fileStats": {
    "size": 9797,
    "lines": 159,
    "lastModified": "2025-12-24T16:45:25.787Z"
  },
  "comments": []
}