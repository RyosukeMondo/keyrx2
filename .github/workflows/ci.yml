name: CI

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  type-check:
    name: Type Consistency Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal

      - name: Cache Cargo for typeshare
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-typeshare-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-typeshare-

      - name: Install typeshare-cli
        run: |
          if ! command -v typeshare &> /dev/null; then
            echo "Installing typeshare-cli..."
            cargo install typeshare-cli
          else
            echo "typeshare-cli already installed (from cache)"
            typeshare --version
          fi

      - name: Regenerate TypeScript types
        run: |
          echo "Regenerating TypeScript types from Rust..."
          cd keyrx_daemon
          typeshare --lang=typescript --output-file=../keyrx_ui/src/types/generated.ts src/
          cd ..

      - name: Check for type differences
        run: |
          echo "Checking if generated types differ from committed types..."
          if git diff --exit-code keyrx_ui/src/types/generated.ts; then
            echo "✅ Types are in sync"
          else
            echo "❌ Type mismatch detected!"
            echo ""
            echo "The generated TypeScript types differ from the committed types."
            echo "This means Rust type definitions have changed without updating TypeScript types."
            echo ""
            echo "Differences:"
            echo "=========================================="
            git diff keyrx_ui/src/types/generated.ts
            echo "=========================================="
            echo ""
            echo "To fix this issue:"
            echo "  1. Run: scripts/check-types.sh --fix"
            echo "  2. Review and commit the updated types"
            echo ""
            exit 1
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: keyrx_ui/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd keyrx_ui
          npm ci

      - name: Run TypeScript type check
        run: |
          cd keyrx_ui
          echo "Running TypeScript compilation check..."
          npm run type-check
          echo "✅ TypeScript compilation successful"

  build-and-verify:
    name: Build and Verify
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    needs: type-check
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: wasm32-unknown-unknown
          components: rustfmt, clippy

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: keyrx_ui/package-lock.json

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-cargo-

      - name: Cache npm
        uses: actions/cache@v3
        with:
          path: keyrx_ui/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('keyrx_ui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install cargo-nextest (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          if ! cargo nextest --version &> /dev/null; then
            echo "Installing cargo-nextest..."
            cargo install cargo-nextest --locked
          else
            echo "cargo-nextest already installed (from cache)"
            cargo nextest --version
          fi

      - name: Install wasm-pack (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Install wasm-pack (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          Invoke-WebRequest -Uri https://github.com/rustwasm/wasm-pack/releases/download/v0.12.1/wasm-pack-v0.12.1-x86_64-pc-windows-msvc.tar.gz -OutFile wasm-pack.tar.gz
          tar -xzf wasm-pack.tar.gz
          Move-Item wasm-pack-v0.12.1-x86_64-pc-windows-msvc\wasm-pack.exe C:\Windows\System32\
        shell: powershell

      - name: Build Project (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          chmod +x scripts/build.sh
          scripts/build.sh

      - name: Build Project (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          # Build WASM
          cd keyrx_core
          wasm-pack build --target web --out-dir ../keyrx_ui/src/wasm/pkg --release --features wasm
          cd ..
          # Build UI
          cd keyrx_ui
          npm ci
          npm run build
          cd ..
          # Build daemon
          cargo build --release -p keyrx_daemon
        shell: powershell

      - name: Install wasm-pack (macOS)
        if: matrix.os == 'macos-latest'
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Build Project (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          chmod +x scripts/build.sh
          scripts/build.sh

      - name: Run Backend Verification (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          chmod +x scripts/verify.sh
          scripts/verify.sh --json

      - name: Run Backend Doc Tests (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          chmod +x scripts/fix_doc_tests.sh
          scripts/fix_doc_tests.sh

      - name: Install cargo-tarpaulin (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          if ! cargo tarpaulin --version &> /dev/null; then
            echo "Installing cargo-tarpaulin..."
            cargo install cargo-tarpaulin
          else
            echo "cargo-tarpaulin already installed (from cache)"
            cargo tarpaulin --version
          fi

      - name: Run Backend Coverage Analysis (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        continue-on-error: false
        id: backend-coverage
        run: |
          chmod +x scripts/test.sh
          scripts/test.sh --coverage 2>&1 | tee backend-coverage-output.log

          # Coverage results are checked in the script (80% threshold for keyrx_core/keyrx_compiler)
          # The script will exit non-zero if coverage is below threshold
          if [ $? -eq 0 ]; then
            echo "✅ Quality gate PASSED: Backend coverage ≥80%"
          else
            echo "❌ Quality gate FAILED: Backend coverage below 80%"
            exit 1
          fi

      # Note: Frontend tests moved to separate parallel jobs for better performance

      - name: Backend Quality Summary (Ubuntu)
        if: matrix.os == 'ubuntu-latest' && always()
        run: |
          echo "=========================================="
          echo "    BACKEND QUALITY GATES SUMMARY"
          echo "=========================================="
          echo ""
          echo "Backend Quality Gates:"
          echo "  ✅ Backend Build & Tests (verify.sh)"
          echo "  ✅ Backend Doc Tests (fix_doc_tests.sh)"

          # Backend coverage status
          if [ "${{ steps.backend-coverage.outcome }}" == "success" ]; then
            echo "  ✅ Backend Coverage (≥80% for keyrx_core/keyrx_compiler)"
          else
            echo "  ❌ Backend Coverage (target: ≥80%)"
          fi

          echo ""
          echo "Note: Frontend quality gates run in parallel jobs"
          echo "See: frontend-quality-summary job for results"
          echo "=========================================="

      - name: Run Verification (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          # Run basic verification for Windows
          cargo fmt --check
          cargo clippy --workspace -- -D warnings
          cargo test --workspace

      - name: Run Verification (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          # Run basic verification for macOS
          cargo fmt --check
          cargo clippy --workspace -- -D warnings
          # Note: Comprehensive macOS tests run in separate macos-tests job
          cargo test --workspace --exclude keyrx_daemon

      - name: Upload Backend Quality Reports (Ubuntu)
        if: matrix.os == 'ubuntu-latest' && always()
        uses: actions/upload-artifact@v3
        with:
          name: backend-quality-reports
          path: |
            cobertura.xml
            coverage/
            backend-coverage-output.log
          retention-days: 30

  frontend-tests:
    name: Frontend Tests (Shard ${{ matrix.shard }}/3)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build-and-verify
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: keyrx_ui/package-lock.json

      - name: Cache npm
        uses: actions/cache@v3
        with:
          path: keyrx_ui/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('keyrx_ui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache Vitest
        uses: actions/cache@v3
        with:
          path: |
            keyrx_ui/node_modules/.vitest
            keyrx_ui/.vitest
          key: ${{ runner.os }}-vitest-${{ hashFiles('keyrx_ui/package-lock.json') }}-${{ hashFiles('keyrx_ui/vitest*.config.ts') }}-${{ hashFiles('keyrx_ui/src/**/*.{ts,tsx}') }}
          restore-keys: |
            ${{ runner.os }}-vitest-${{ hashFiles('keyrx_ui/package-lock.json') }}-${{ hashFiles('keyrx_ui/vitest*.config.ts') }}-
            ${{ runner.os }}-vitest-${{ hashFiles('keyrx_ui/package-lock.json') }}-
            ${{ runner.os }}-vitest-

      - name: Install dependencies
        working-directory: keyrx_ui
        run: npm ci

      - name: Run test shard
        working-directory: keyrx_ui
        env:
          SHARD_INDEX: ${{ matrix.shard }}
          SHARD_COUNT: 3
        run: |
          npm run test:shard 2>&1 | tee test-shard-${{ matrix.shard }}.log

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-shard-${{ matrix.shard }}
          path: keyrx_ui/test-shard-${{ matrix.shard }}.log
          retention-days: 7

  frontend-accessibility:
    name: Accessibility Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-and-verify

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: keyrx_ui/package-lock.json

      - name: Cache npm
        uses: actions/cache@v3
        with:
          path: keyrx_ui/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('keyrx_ui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache Vitest
        uses: actions/cache@v3
        with:
          path: |
            keyrx_ui/node_modules/.vitest
            keyrx_ui/.vitest
          key: ${{ runner.os }}-vitest-a11y-${{ hashFiles('keyrx_ui/package-lock.json') }}-${{ hashFiles('keyrx_ui/vitest*.config.ts') }}
          restore-keys: |
            ${{ runner.os }}-vitest-a11y-${{ hashFiles('keyrx_ui/package-lock.json') }}-
            ${{ runner.os }}-vitest-a11y-

      - name: Install dependencies
        working-directory: keyrx_ui
        run: npm ci

      - name: Run Accessibility Audit
        working-directory: keyrx_ui
        run: |
          npm run test:a11y -- --run 2>&1 | tee a11y-output.log

          # Quality gate: Zero WCAG 2.2 Level AA violations (STRICT - blocks merge)
          if grep -q " failed" a11y-output.log; then
            echo "❌ Quality gate FAILED: WCAG 2.2 Level AA violations detected"
            exit 1
          fi

          if grep -q " passed" a11y-output.log; then
            echo "✅ Quality gate PASSED: Zero WCAG 2.2 Level AA violations"
          else
            echo "❌ Quality gate FAILED: Accessibility tests did not run correctly"
            exit 1
          fi

      - name: Upload accessibility results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: accessibility-results
          path: keyrx_ui/a11y-output.log
          retention-days: 7

  frontend-coverage:
    name: Frontend Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build-and-verify

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: keyrx_ui/package-lock.json

      - name: Cache npm
        uses: actions/cache@v3
        with:
          path: keyrx_ui/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('keyrx_ui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache Vitest
        uses: actions/cache@v3
        with:
          path: |
            keyrx_ui/node_modules/.vitest
            keyrx_ui/.vitest
          key: ${{ runner.os }}-vitest-coverage-${{ hashFiles('keyrx_ui/package-lock.json') }}-${{ hashFiles('keyrx_ui/vitest*.config.ts') }}
          restore-keys: |
            ${{ runner.os }}-vitest-coverage-${{ hashFiles('keyrx_ui/package-lock.json') }}-
            ${{ runner.os }}-vitest-coverage-

      - name: Install dependencies
        working-directory: keyrx_ui
        run: npm ci

      - name: Run coverage analysis
        working-directory: keyrx_ui
        continue-on-error: true
        id: coverage
        run: |
          npm run test:coverage -- --run --reporter=json --outputFile.json=/tmp/test-output.json 2>&1 | tee coverage-output.log || true

          # Quality gate: ≥80% coverage required for production
          if grep -q "ERROR: Coverage for" coverage-output.log; then
            echo "⚠️  Quality gate WARNING: Coverage below 80% threshold"
            echo "    Note: Coverage analysis may be incomplete due to test failures"
            exit 1
          fi

          if grep -q "Coverage" coverage-output.log && ! grep -q "ERROR" coverage-output.log; then
            echo "✅ Quality gate PASSED: Coverage ≥80%"
          else
            echo "⚠️  Quality gate WARNING: Coverage analysis incomplete"
            exit 1
          fi

      - name: Collect test metrics
        if: always()
        run: |
          chmod +x scripts/test-metrics.sh

          # Collect metrics from test run
          if [ -f /tmp/test-output.json ]; then
            scripts/test-metrics.sh \
              --test-output /tmp/test-output.json \
              --output test-metrics.json \
              --json > test-metrics-output.json || true

            echo "Test metrics collected"
            cat test-metrics.json | jq . || echo "Failed to parse metrics JSON"
          else
            echo "No test output found - skipping metrics collection"
          fi

      - name: Track coverage trend
        continue-on-error: true
        run: |
          chmod +x scripts/coverage-trend.sh

          if [ "${{ github.ref }}" == "refs/heads/main" ] && [ "${{ steps.coverage.outcome }}" == "success" ]; then
            echo "Main branch - updating coverage baseline"
            scripts/coverage-trend.sh --update-baseline
          else
            echo "Checking for coverage regression..."
            scripts/coverage-trend.sh --generate-badge --json | tee coverage-trend.json || true
            if [ -f coverage-trend.json ]; then
              cat coverage-trend.json
            fi
          fi

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: frontend-coverage
          path: |
            keyrx_ui/coverage/
            keyrx_ui/coverage-output.log
            coverage-trend.json
            .coverage-baseline.json
            test-metrics.json
            test-metrics-output.json
          retention-days: 30

  frontend-quality-summary:
    name: Frontend Quality Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [frontend-tests, frontend-accessibility, frontend-coverage]
    if: always()

    steps:
      - name: Check results
        run: |
          echo "=========================================="
          echo "  FRONTEND QUALITY GATES SUMMARY"
          echo "=========================================="
          echo ""
          echo "Tests (3 shards): ${{ needs.frontend-tests.result }}"
          echo "Accessibility: ${{ needs.frontend-accessibility.result }}"
          echo "Coverage: ${{ needs.frontend-coverage.result }}"
          echo ""
          if [ "${{ needs.frontend-tests.result }}" != "success" ] || [ "${{ needs.frontend-accessibility.result }}" != "success" ]; then
            echo "❌ Some quality gates failed"
            exit 1
          else
            echo "✅ All critical quality gates passed"
          fi

  e2e-playwright-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [build-and-verify, frontend-quality-summary]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: keyrx_ui/package-lock.json

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-e2e-playwright-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-e2e-playwright-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-cargo-e2e-playwright-
            ${{ runner.os }}-cargo-

      - name: Build daemon
        run: cargo build --release -p keyrx_daemon

      - name: Build compiler
        run: cargo build --release -p keyrx_compiler

      - name: Install frontend dependencies
        working-directory: keyrx_ui
        run: npm ci

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('keyrx_ui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: keyrx_ui
        run: npx playwright install chromium --with-deps

      - name: Install Playwright dependencies (cache hit)
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        working-directory: keyrx_ui
        run: npx playwright install-deps chromium

      - name: Setup test environment
        run: |
          mkdir -p ~/.config/keyrx/profiles
          # Create minimal test profile
          cat > ~/.config/keyrx/profiles/E2E.rhai << 'EOF'
          // Minimal E2E test profile
          device_start("*");
          device_end();
          EOF
          ./target/release/keyrx_compiler compile ~/.config/keyrx/profiles/E2E.rhai -o ~/.config/keyrx/profiles/E2E.krx
          echo "E2E test profile created"

      - name: Run E2E tests
        id: e2e-tests
        working-directory: keyrx_ui
        run: npm run test:e2e:ci

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: keyrx_ui/playwright-report/
          retention-days: 30

      - name: Upload Playwright test results (JSON)
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-test-results
          path: keyrx_ui/test-results/
          retention-days: 30

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-screenshots
          path: keyrx_ui/test-results/**/*.png
          retention-days: 7

      - name: Upload videos on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-videos
          path: keyrx_ui/test-results/**/*.webm
          retention-days: 7

  test-docs:
    name: Test Documentation Accuracy
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [type-check, build-and-verify]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-test-docs-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-docs-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-cargo-test-docs-
            ${{ runner.os }}-cargo-

      - name: Build Compiler
        run: cargo build --release -p keyrx_compiler

      - name: Test Example Configurations
        run: |
          echo "Testing example .rhai files..."
          for f in examples/*.rhai; do
            echo "Compiling $f..."
            cargo run --release -p keyrx_compiler -- compile "$f" -o /tmp/test.krx || exit 1
            echo "✓ $f compiled successfully"
          done
          echo "All examples compiled successfully!"

      - name: Extract and Test DSL Manual Code Blocks
        run: |
          echo "Extracting code blocks from DSL_MANUAL.md..."
          # Extract code blocks marked with ```rhai
          awk '/```rhai/,/```/ {if (!/```/) print}' docs/DSL_MANUAL.md > /tmp/manual_examples.rhai || true
          if [ -s /tmp/manual_examples.rhai ]; then
            echo "Found $(wc -l < /tmp/manual_examples.rhai) lines of example code"
            echo "Testing extracted code blocks..."
            # Note: Manual examples may be snippets, not complete configs
            # We just verify they don't contain obvious syntax errors
            cargo run --release -p keyrx_compiler -- parse /tmp/manual_examples.rhai > /dev/null 2>&1 || {
              echo "Note: Some manual examples are snippets, not complete standalone configs"
              echo "This is expected for documentation. Individual examples/*.rhai files are tested above."
            }
          else
            echo "No code blocks found in DSL_MANUAL.md (this is unusual)"
          fi
          echo "DSL manual check complete"

  virtual-e2e-tests:
    name: Virtual E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [type-check, build-and-verify]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-e2e-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-cargo-e2e-
            ${{ runner.os }}-cargo-

      - name: Setup uinput permissions
        run: |
          # Load uinput kernel module
          sudo modprobe uinput
          # Set permissions on uinput device
          sudo chmod 666 /dev/uinput
          # Verify uinput is available
          ls -la /dev/uinput

      - name: Build daemon with Linux features
        run: cargo build --release -p keyrx_daemon --features linux

      - name: Build compiler
        run: cargo build --release -p keyrx_compiler

      - name: Run virtual E2E tests
        id: e2e-tests
        run: |
          # Run the virtual E2E tests (auto-skip if uinput not accessible)
          cargo test --test virtual_e2e_tests --features linux -- --test-threads=1 2>&1 | tee e2e-test-output.log
        continue-on-error: true

      - name: Upload test logs on failure
        if: steps.e2e-tests.outcome == 'failure'
        uses: actions/upload-artifact@v3
        with:
          name: e2e-test-logs
          path: |
            e2e-test-output.log
            /tmp/keyrx-e2e-*.log
          retention-days: 7

      - name: Check test results
        if: steps.e2e-tests.outcome == 'failure'
        run: |
          echo "Virtual E2E tests failed. See uploaded logs for details."
          exit 1

  api-contract-tests:
    name: API Contract Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [type-check, build-and-verify]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: keyrx_ui/package-lock.json

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-contract-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-contract-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-cargo-contract-
            ${{ runner.os }}-cargo-

      - name: Build daemon
        run: cargo build --release -p keyrx_daemon

      - name: Build compiler
        run: cargo build --release -p keyrx_compiler

      - name: Install frontend dependencies
        working-directory: keyrx_ui
        run: npm ci

      - name: Setup test profile
        run: |
          mkdir -p ~/.config/keyrx/profiles
          cat > ~/.config/keyrx/profiles/Test.rhai << 'EOF'
          // Minimal test profile for CI
          device_start("*");
          device_end();
          EOF
          ./target/release/keyrx_compiler compile ~/.config/keyrx/profiles/Test.rhai -o ~/.config/keyrx/profiles/Test.krx
          echo "Test profile created and compiled"

      - name: Start daemon
        run: |
          # Start daemon in background (will fail to grab keyboards, but web API still works)
          ./target/release/keyrx_daemon run --config ~/.config/keyrx/profiles/Test.krx &
          DAEMON_PID=$!
          echo "DAEMON_PID=$DAEMON_PID" >> $GITHUB_ENV

          # Wait for daemon to be ready
          echo "Waiting for daemon to start..."
          for i in {1..30}; do
            if curl -s http://localhost:9867/api/status > /dev/null 2>&1; then
              echo "Daemon is ready (attempt $i)"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "Daemon failed to start within 30 seconds"
              exit 1
            fi
            sleep 1
          done

      - name: Run contract validation
        id: contract-validation
        working-directory: keyrx_ui
        run: |
          npm run validate:contracts 2>&1 | tee contract-validation.log
          echo "Contract validation completed"

      - name: Stop daemon
        if: always()
        run: |
          if [ -n "$DAEMON_PID" ]; then
            kill $DAEMON_PID 2>/dev/null || true
          fi
          pkill -f keyrx_daemon || true

      - name: Upload contract validation results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: contract-validation-results
          path: |
            keyrx_ui/contract-validation.log
          retention-days: 7

  macos-tests:
    name: macOS Comprehensive Tests
    runs-on: macos-latest
    timeout-minutes: 20
    needs: [type-check, build-and-verify]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable

      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-macos-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-macos-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-cargo-macos-
            ${{ runner.os }}-cargo-

      - name: Make scripts executable
        run: |
          chmod +x scripts/test_macos_full.sh
          chmod +x scripts/check_macos_permission.sh

      - name: Run comprehensive macOS test suite
        id: macos-tests
        run: |
          # Run the comprehensive test suite
          # E2E tests will auto-skip gracefully without Accessibility permission
          scripts/test_macos_full.sh 2>&1 | tee macos-test-output.log
        continue-on-error: false

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: macos-test-results
          path: |
            macos-test-output.log
          retention-days: 7

      - name: Check test results
        if: steps.macos-tests.outcome == 'failure'
        run: |
          echo "macOS comprehensive tests failed. See uploaded logs for details."
          exit 1
