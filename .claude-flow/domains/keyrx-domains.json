{
  "version": "1.0.0",
  "description": "Domain-Driven Design domains for keyrx keyboard remapping system",
  "domains": [
    {
      "name": "Core",
      "description": "Platform-agnostic remapping logic (no_std)",
      "crate": "keyrx_core",
      "entities": [
        "Config",
        "ExtendedState",
        "DFA",
        "MPHFLookup",
        "KeyEvent",
        "Action"
      ],
      "repositories": [
        "config-loader",
        "state-manager"
      ],
      "services": [
        "event-processor",
        "state-machine",
        "lookup-service"
      ],
      "constraints": [
        "no_std compatible",
        "zero heap allocation in hot path",
        "<100μs latency",
        "deterministic behavior",
        "WASM compilable"
      ],
      "testingRequirements": [
        "90% coverage minimum",
        "DST (Deterministic Simulation Testing)",
        "PBT (Property-Based Testing)",
        "Fuzz testing"
      ]
    },
    {
      "name": "Compiler",
      "description": "Rhai script → .krx binary compiler",
      "crate": "keyrx_compiler",
      "entities": [
        "RhaiScript",
        "AST",
        "CompilationUnit",
        "BinaryConfig"
      ],
      "repositories": [
        "script-parser",
        "binary-serializer"
      ],
      "services": [
        "rhai-evaluator",
        "mphf-generator",
        "dfa-generator",
        "config-validator"
      ],
      "constraints": [
        "compile-time only (no runtime)",
        "deterministic compilation",
        "validate 255 modifiers + 255 locks",
        "circular import detection"
      ],
      "testingRequirements": [
        "80% coverage minimum",
        "test all error paths",
        "validate complex configs (255x255)"
      ]
    },
    {
      "name": "Daemon",
      "description": "OS integration and web server",
      "crate": "keyrx_daemon",
      "entities": [
        "InputDevice",
        "OutputDevice",
        "DeviceEntry",
        "WebServer",
        "WebSocketConnection"
      ],
      "repositories": [
        "device-manager",
        "config-storage",
        "profile-storage"
      ],
      "services": [
        "platform-service",
        "web-api",
        "websocket-service",
        "device-identification"
      ],
      "constraints": [
        "lock-free event processing",
        "structured JSON logging",
        "graceful degradation",
        "cross-device state synchronization"
      ],
      "testingRequirements": [
        "80% coverage minimum",
        "platform-specific tests (Linux, Windows)",
        "integration tests",
        "VM testing for Windows"
      ]
    },
    {
      "name": "UI",
      "description": "React + WASM frontend",
      "crate": "keyrx_ui",
      "entities": [
        "Component",
        "WASMBinding",
        "DaemonConnection",
        "Profile",
        "Layer"
      ],
      "repositories": [
        "local-storage",
        "daemon-api-client"
      ],
      "services": [
        "wasm-simulator",
        "websocket-client",
        "state-visualization"
      ],
      "constraints": [
        "TypeScript strict mode",
        "WCAG accessibility",
        "WASM byte-for-byte simulation",
        "responsive design"
      ],
      "testingRequirements": [
        "95% test pass rate",
        "80% coverage target",
        "zero WCAG violations",
        "E2E tests with Playwright"
      ]
    },
    {
      "name": "Platform",
      "description": "OS-specific implementations",
      "subdomains": [
        {
          "name": "Linux",
          "technologies": ["evdev", "uinput", "EVIOCGRAB"],
          "entities": ["EvdevDevice", "UinputDevice", "DeviceSerial"],
          "constraints": ["kernel 5.0+", "device permissions"]
        },
        {
          "name": "Windows",
          "technologies": ["Low-Level Hooks", "Raw Input", "SendInput"],
          "entities": ["RawInputDevice", "HookCallback", "DeviceSerial"],
          "constraints": ["Windows 10+", "admin permissions for hooks"]
        }
      ],
      "services": [
        "device-enumeration",
        "serial-extraction",
        "input-interception",
        "output-injection"
      ],
      "testingRequirements": [
        "VM testing for cross-platform",
        "device mocking for unit tests"
      ]
    },
    {
      "name": "Testing",
      "description": "Comprehensive testing infrastructure",
      "entities": [
        "TestFixture",
        "MockDevice",
        "VirtualClock",
        "PropertyTest"
      ],
      "services": [
        "deterministic-simulation",
        "property-based-testing",
        "fuzz-testing",
        "e2e-testing",
        "coverage-reporting"
      ],
      "frameworks": [
        "cargo test",
        "proptest",
        "cargo-fuzz",
        "Playwright",
        "vitest",
        "tarpaulin"
      ],
      "constraints": [
        "deterministic behavior",
        "no time dependencies in tests",
        "AI-verifiable outputs"
      ]
    },
    {
      "name": "Configuration",
      "description": "Multi-device configuration management",
      "entities": [
        "Profile",
        "Device",
        "Layer",
        "Modifier",
        "TapHold",
        "Macro"
      ],
      "repositories": [
        "profile-repository",
        "device-repository",
        "layer-repository"
      ],
      "services": [
        "config-merger",
        "profile-switcher",
        "device-matcher"
      ],
      "patterns": [
        "Single entry point (main.rhai)",
        "Modular imports",
        "Conditional loading",
        "Cross-device state sharing"
      ]
    },
    {
      "name": "Quality",
      "description": "Code quality and enforcement",
      "services": [
        "clippy-linter",
        "formatter",
        "coverage-checker",
        "file-size-verifier",
        "pre-commit-hooks"
      ],
      "constraints": [
        "500 lines max per file",
        "50 lines max per function",
        "80% coverage minimum (90% for core)",
        "zero clippy warnings"
      ],
      "enforcement": [
        "pre-commit hooks",
        "CI/CD gates",
        "automated verification"
      ]
    }
  ],
  "crossCuttingConcerns": {
    "logging": {
      "format": "JSON",
      "schema": {
        "required": ["timestamp", "level", "service", "event_type", "context"],
        "forbidden": ["secrets", "PII"]
      },
      "purpose": "AI-parseable, machine-verifiable logging"
    },
    "ssot": {
      "principle": "Single Source of Truth",
      "implementation": ".krx binary as canonical config",
      "verification": "hash-based equality checking"
    },
    "determinism": {
      "principle": "Same input → same output",
      "enforcement": [
        "virtual clock in tests",
        "seeded RNG",
        "no wall-clock dependencies"
      ]
    },
    "latency": {
      "target": "<100μs processing",
      "hard_limit": "<1ms",
      "measurement": "per-event latency histograms"
    }
  }
}
