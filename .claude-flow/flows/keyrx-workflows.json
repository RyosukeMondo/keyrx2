{
  "version": "1.0.0",
  "description": "Development workflows for keyrx",
  "flows": [
    {
      "name": "spec-implementation",
      "description": "Implement a spec from .spec-workflow",
      "version": "1.0.0",
      "triggers": {
        "manual": true,
        "command": "claude-flow flow run spec-implementation --spec <spec-name>"
      },
      "stages": [
        {
          "name": "planning",
          "agents": ["spec-planner"],
          "tasks": [
            {
              "id": "load-spec",
              "description": "Load spec from .spec-workflow/specs/<spec-name>",
              "agent": "spec-planner",
              "timeout": 120000,
              "tools": ["Read", "mcp__spec-workflow__spec-workflow-guide", "mcp__spec-workflow__spec-status"]
            },
            {
              "id": "analyze-requirements",
              "description": "Parse requirements.md and understand scope",
              "agent": "spec-planner",
              "depends_on": ["load-spec"],
              "tools": ["Read"]
            },
            {
              "id": "review-design",
              "description": "Review design.md for implementation approach",
              "agent": "spec-planner",
              "depends_on": ["analyze-requirements"],
              "tools": ["Read"]
            },
            {
              "id": "parse-tasks",
              "description": "Parse tasks.md and create execution plan",
              "agent": "spec-planner",
              "depends_on": ["review-design"],
              "tools": ["Read", "TaskCreate"]
            }
          ]
        },
        {
          "name": "implementation",
          "agents": ["spec-implementer", "rust-core-dev", "daemon-dev", "ui-react-dev"],
          "parallel": true,
          "tasks": [
            {
              "id": "implement-tasks",
              "description": "Execute tasks from tasks.md",
              "agent": "spec-implementer",
              "input": "{{planning.parse-tasks.output}}",
              "tools": ["Read", "Edit", "Write", "Bash", "mcp__spec-workflow__log-implementation"]
            },
            {
              "id": "create-artifacts",
              "description": "Document APIs, components, functions, integrations",
              "agent": "spec-implementer",
              "depends_on": ["implement-tasks"],
              "tools": ["mcp__spec-workflow__log-implementation"]
            }
          ]
        },
        {
          "name": "testing",
          "agents": ["unit-tester", "e2e-tester", "coverage-checker"],
          "tasks": [
            {
              "id": "unit-tests",
              "description": "Write and run unit tests",
              "agent": "unit-tester",
              "testType": "unit",
              "tools": ["Read", "Edit", "Write", "Bash"]
            },
            {
              "id": "e2e-tests",
              "description": "Write and run E2E tests if UI changes",
              "agent": "e2e-tester",
              "depends_on": ["unit-tests"],
              "tools": ["Read", "Edit", "Write", "Bash"]
            },
            {
              "id": "coverage-check",
              "description": "Verify coverage meets minimum thresholds",
              "agent": "coverage-checker",
              "depends_on": ["unit-tests", "e2e-tests"],
              "constraints": {
                "minimumCoverage": 80,
                "coreCoverage": 90
              },
              "tools": ["Bash", "Read"]
            }
          ]
        },
        {
          "name": "quality-gates",
          "agents": ["clippy-enforcer", "formatter", "coverage-checker"],
          "tasks": [
            {
              "id": "clippy-check",
              "description": "Run clippy with zero warnings",
              "agent": "clippy-enforcer",
              "tools": ["Bash", "Read", "Edit"]
            },
            {
              "id": "format-check",
              "description": "Run cargo fmt and prettier",
              "agent": "formatter",
              "tools": ["Bash"]
            },
            {
              "id": "verify-coverage",
              "description": "Final coverage verification",
              "agent": "coverage-checker",
              "depends_on": ["clippy-check", "format-check"],
              "tools": ["Bash", "Read"]
            }
          ]
        },
        {
          "name": "review",
          "agents": ["spec-reviewer"],
          "tasks": [
            {
              "id": "verify-artifacts",
              "description": "Verify all artifacts logged correctly",
              "agent": "spec-reviewer",
              "tools": ["Read", "mcp__spec-workflow__spec-status"]
            },
            {
              "id": "request-approval",
              "description": "Request approval via spec-workflow dashboard",
              "agent": "spec-reviewer",
              "depends_on": ["verify-artifacts"],
              "tools": ["mcp__spec-workflow__approvals"]
            }
          ]
        }
      ],
      "consensus": {
        "algorithm": "byzantine",
        "threshold": 0.67,
        "timeout": 10000
      },
      "rollback": {
        "enabled": true,
        "trigger": "failure-rate > 0.3"
      }
    },
    {
      "name": "feature-development",
      "description": "Full feature development cycle",
      "version": "1.0.0",
      "triggers": {
        "manual": true,
        "command": "claude-flow flow run feature-development --feature <feature-name>"
      },
      "stages": [
        {
          "name": "planning",
          "agents": ["architecture-coordinator"],
          "tasks": [
            {
              "id": "requirements",
              "description": "Gather requirements and create spec",
              "agent": "architecture-coordinator",
              "timeout": 300000,
              "tools": ["Read", "mcp__spec-workflow__spec-workflow-guide"]
            },
            {
              "id": "design",
              "description": "Design architecture and approach",
              "agent": "architecture-coordinator",
              "depends_on": ["requirements"],
              "tools": ["Read", "Write"]
            }
          ]
        },
        {
          "name": "implementation",
          "agents": ["rust-core-dev", "daemon-dev", "ui-react-dev", "compiler-dev"],
          "parallel": true,
          "tasks": [
            {
              "id": "core-impl",
              "description": "Implement core logic if needed",
              "agent": "rust-core-dev",
              "input": "{{planning.design.output}}",
              "tools": ["Read", "Edit", "Write", "Bash"]
            },
            {
              "id": "daemon-impl",
              "description": "Implement daemon changes if needed",
              "agent": "daemon-dev",
              "input": "{{planning.design.output}}",
              "tools": ["Read", "Edit", "Write", "Bash"]
            },
            {
              "id": "ui-impl",
              "description": "Implement UI changes if needed",
              "agent": "ui-react-dev",
              "input": "{{planning.design.output}}",
              "tools": ["Read", "Edit", "Write", "Bash"]
            }
          ]
        },
        {
          "name": "testing",
          "agents": ["unit-tester", "dst-tester", "pbt-tester", "e2e-tester"],
          "tasks": [
            {
              "id": "unit-tests",
              "description": "Comprehensive unit testing",
              "agent": "unit-tester",
              "tools": ["Read", "Edit", "Write", "Bash"]
            },
            {
              "id": "dst-tests",
              "description": "Deterministic simulation tests",
              "agent": "dst-tester",
              "tools": ["Read", "Edit", "Write", "Bash"]
            },
            {
              "id": "property-tests",
              "description": "Property-based testing",
              "agent": "pbt-tester",
              "tools": ["Read", "Edit", "Write", "Bash"]
            },
            {
              "id": "e2e-tests",
              "description": "End-to-end tests",
              "agent": "e2e-tester",
              "tools": ["Read", "Edit", "Write", "Bash"]
            }
          ]
        },
        {
          "name": "quality",
          "agents": ["clippy-enforcer", "formatter", "coverage-checker"],
          "tasks": [
            {
              "id": "quality-gates",
              "description": "Run all quality checks",
              "agent": "clippy-enforcer",
              "tools": ["Bash", "Read", "Edit"]
            }
          ]
        }
      ]
    },
    {
      "name": "bug-fix",
      "description": "Quick bug fix workflow",
      "version": "1.0.0",
      "triggers": {
        "manual": true,
        "command": "claude-flow flow run bug-fix --issue <issue-id>"
      },
      "stages": [
        {
          "name": "investigation",
          "agents": ["architecture-coordinator"],
          "tasks": [
            {
              "id": "identify-root-cause",
              "description": "Debug and identify root cause",
              "agent": "architecture-coordinator",
              "timeout": 300000,
              "tools": ["Read", "Grep", "Bash"]
            }
          ]
        },
        {
          "name": "fix",
          "agents": ["rust-core-dev", "daemon-dev", "ui-react-dev"],
          "tasks": [
            {
              "id": "implement-fix",
              "description": "Implement the fix",
              "agent": "AUTO_SELECT",
              "input": "{{investigation.identify-root-cause.output}}",
              "tools": ["Read", "Edit", "Bash"]
            }
          ]
        },
        {
          "name": "verification",
          "agents": ["unit-tester", "clippy-enforcer"],
          "tasks": [
            {
              "id": "regression-test",
              "description": "Create regression test",
              "agent": "unit-tester",
              "tools": ["Read", "Edit", "Write", "Bash"]
            },
            {
              "id": "quality-check",
              "description": "Quick quality check",
              "agent": "clippy-enforcer",
              "depends_on": ["regression-test"],
              "tools": ["Bash", "Read"]
            }
          ]
        }
      ]
    },
    {
      "name": "quality-verification",
      "description": "Full quality verification suite",
      "version": "1.0.0",
      "triggers": {
        "manual": true,
        "command": "make verify",
        "preCommit": true
      },
      "stages": [
        {
          "name": "rust-quality",
          "agents": ["clippy-enforcer", "formatter"],
          "parallel": true,
          "tasks": [
            {
              "id": "clippy",
              "description": "Run clippy on workspace",
              "agent": "clippy-enforcer",
              "command": "cargo clippy --workspace -- -D warnings",
              "tools": ["Bash"]
            },
            {
              "id": "rustfmt",
              "description": "Check Rust formatting",
              "agent": "formatter",
              "command": "cargo fmt --check",
              "tools": ["Bash"]
            }
          ]
        },
        {
          "name": "typescript-quality",
          "agents": ["formatter"],
          "tasks": [
            {
              "id": "prettier",
              "description": "Check TypeScript formatting",
              "agent": "formatter",
              "command": "cd keyrx_ui && npm run format:check",
              "tools": ["Bash"]
            }
          ]
        },
        {
          "name": "tests",
          "agents": ["unit-tester", "e2e-tester"],
          "parallel": true,
          "tasks": [
            {
              "id": "backend-tests",
              "description": "Run all backend tests",
              "agent": "unit-tester",
              "command": "cargo test --workspace",
              "tools": ["Bash"]
            },
            {
              "id": "frontend-tests",
              "description": "Run all frontend tests",
              "agent": "unit-tester",
              "command": "cd keyrx_ui && npm test",
              "tools": ["Bash"]
            },
            {
              "id": "e2e-tests",
              "description": "Run E2E tests",
              "agent": "e2e-tester",
              "command": "cd keyrx_ui && npm run test:e2e",
              "tools": ["Bash"]
            }
          ]
        },
        {
          "name": "coverage",
          "agents": ["coverage-checker"],
          "tasks": [
            {
              "id": "backend-coverage",
              "description": "Check backend coverage",
              "agent": "coverage-checker",
              "command": "cargo tarpaulin --workspace",
              "constraints": {
                "minimumCoverage": 80
              },
              "tools": ["Bash", "Read"]
            },
            {
              "id": "frontend-coverage",
              "description": "Check frontend coverage",
              "agent": "coverage-checker",
              "command": "cd keyrx_ui && npm run test:coverage",
              "constraints": {
                "minimumCoverage": 80
              },
              "tools": ["Bash", "Read"]
            }
          ]
        }
      ],
      "failFast": true
    },
    {
      "name": "windows-vm-test",
      "description": "Windows platform testing via Vagrant VM",
      "version": "1.0.0",
      "triggers": {
        "manual": true,
        "command": "scripts/windows_test_vm.sh"
      },
      "stages": [
        {
          "name": "vm-setup",
          "agents": ["windows-vm-tester"],
          "tasks": [
            {
              "id": "start-vm",
              "description": "Start Windows Vagrant VM",
              "agent": "windows-vm-tester",
              "command": "cd vagrant/windows && vagrant up",
              "timeout": 600000,
              "tools": ["Bash"]
            }
          ]
        },
        {
          "name": "testing",
          "agents": ["windows-vm-tester", "platform-windows-dev"],
          "tasks": [
            {
              "id": "run-tests",
              "description": "Run Windows-specific tests",
              "agent": "windows-vm-tester",
              "command": "vagrant winrm -c 'cd C:\\vagrant_project; cargo test -p keyrx_daemon --features windows'",
              "depends_on": ["start-vm"],
              "tools": ["Bash"]
            },
            {
              "id": "verify-results",
              "description": "Verify test results",
              "agent": "platform-windows-dev",
              "depends_on": ["run-tests"],
              "tools": ["Read", "Bash"]
            }
          ]
        },
        {
          "name": "cleanup",
          "agents": ["windows-vm-tester"],
          "tasks": [
            {
              "id": "snapshot-restore",
              "description": "Restore VM to clean state",
              "agent": "windows-vm-tester",
              "command": "cd vagrant/windows && vagrant snapshot restore provisioned",
              "tools": ["Bash"]
            }
          ]
        }
      ]
    },
    {
      "name": "wasm-build-verify",
      "description": "WASM build and verification",
      "version": "1.0.0",
      "triggers": {
        "manual": true,
        "command": "scripts/wasm-health.sh"
      },
      "stages": [
        {
          "name": "build",
          "agents": ["wasm-dev"],
          "tasks": [
            {
              "id": "build-wasm",
              "description": "Build WASM module",
              "agent": "wasm-dev",
              "command": "cd keyrx_ui && npm run build:wasm",
              "tools": ["Bash"]
            }
          ]
        },
        {
          "name": "verification",
          "agents": ["wasm-dev"],
          "tasks": [
            {
              "id": "verify-wasm",
              "description": "Verify WASM integrity",
              "agent": "wasm-dev",
              "command": "scripts/verify-wasm.sh",
              "depends_on": ["build-wasm"],
              "tools": ["Bash", "Read"]
            },
            {
              "id": "health-check",
              "description": "Run WASM health diagnostics",
              "agent": "wasm-dev",
              "command": "scripts/wasm-health.sh",
              "depends_on": ["verify-wasm"],
              "tools": ["Bash"]
            }
          ]
        }
      ]
    }
  ],
  "defaultFlow": "spec-implementation",
  "errorHandling": {
    "retryPolicy": {
      "maxAttempts": 3,
      "backoffMultiplier": 2
    },
    "fallbackStrategies": [
      "rollback to previous state",
      "notify user",
      "log error with context"
    ]
  }
}
